============================= test session starts =============================
platform win32 -- Python 3.13.0, pytest-9.0.1, pluggy-1.6.0 -- E:\python\python313\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\lihuo\Desktop\重构\TG ONE
configfile: pytest.ini
plugins: anyio-4.12.1, asyncio-1.3.0, cov-7.0.0, mock-3.15.1, xdist-3.8.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 5 items

tests/integration/test_auth_router.py::TestAuthRouter::test_login_success 
------------------------------- live log setup --------------------------------
2026-01-30 18:21:08 [    INFO] Failed to load SSL library: <class 'OSError'> (no library called "ssl" found)
2026-01-30 18:21:08 [    INFO] cryptg module not installed and libssl not found, falling back to (slower) Python encryption
2026-01-30 18:21:08 [    INFO] Bloom Filter (L0) 初始化成功
2026-01-30 18:21:08 [    INFO] HLL (HyperLogLog) 初始化成功
2026-01-30 18:21:08 [    INFO] SimHash 引擎与 LSH Forest 索引系统初始化成功
2026-01-30 18:21:08 [    INFO] Bloom Filter Service initialized using consolidated utils implementation
2026-01-30 18:21:08 [    INFO] 使用转发记录目录: C:\app\zhuanfaji
2026-01-30 18:21:08 [    INFO] ForwardRecorder 初始化完成，模式: full
2026-01-30 18:21:08 [    INFO] [Database] 初始化数据库连接，模式=共享引擎
2026-01-30 18:21:08 [    INFO] [Database] 使用共享引擎: sqlite+aiosqlite:///file:testdb_master?cache=shared&mode=memory&uri=true
2026-01-30 18:21:08 [    INFO] [Database] 会话工厂已初始化
2026-01-30 18:21:08 [    INFO] Container connected to shared database engine: sqlite+aiosqlite:///file:testdb_master?cache=shared&mode=memory&uri=true
2026-01-30 18:21:08 [    INFO] EventBus initialized
-------------------------------- live log call --------------------------------
2026-01-30 18:21:09 [    INFO] \U0001f310 [WebAPI] \u8bf7\u6c42\u5f00\u59cb: TraceID=192d226e-6eb7-4fea-99da-314d3454374e, IP=127.0.0.1, \u65b9\u6cd5=GET, \u8def\u5f84=/\n2026-01-30 18:21:09 [    INFO] \u2705 [WebAPI] \u8bf7\u6c42\u5b8c\u6210: TraceID=192d226e-6eb7-4fea-99da-314d3454374e, IP=127.0.0.1, \u65b9\u6cd5=GET, \u8def\u5f84=/, \u72b6\u6001\u7801=200, \u8017\u65f6=7.32ms\n2026-01-30 18:21:09 [    INFO] HTTP Request: GET http://test/ "HTTP/1.1 200 OK"
2026-01-30 18:21:09 [    INFO] \U0001f310 [WebAPI] \u8bf7\u6c42\u5f00\u59cb: TraceID=ef15b24b-dcb1-49ae-86c1-7da5cf2f6a18, IP=127.0.0.1, \u65b9\u6cd5=POST, \u8def\u5f84=/api/auth/login\n2026-01-30 18:21:09 [    INFO] 登录限流器已初始化
2026-01-30 18:21:09 [    INFO] \U0001f510 [Auth] \u7528\u6237\u8ba4\u8bc1\u8bf7\u6c42: \u7528\u6237\u540d=testuser\n2026-01-30 18:21:09 [    INFO] \u2705 [Auth] \u7528\u6237\u8ba4\u8bc1\u6210\u529f: \u7528\u6237\u540d=testuser, \u7528\u6237ID=1\n2026-01-30 18:21:09 [    INFO] 登录成功，已清除限流记录: username=testuser
2026-01-30 18:21:09 [    INFO] \U0001f195 [Auth] \u521b\u5efa\u4f1a\u8bdd: \u7528\u6237ID=1, IP=127.0.0.1\n2026-01-30 18:21:09 [    INFO] \u2705 [Auth] \u4f1a\u8bdd\u521b\u5efa\u6210\u529f: \u7528\u6237ID=1, IP=127.0.0.1, \u4f1a\u8bddID=3e494706-2f72-4179-9a26-c98852ab57e5\n2026-01-30 18:21:09 [    INFO] \u2705 [WebAPI] \u8bf7\u6c42\u5b8c\u6210: TraceID=ef15b24b-dcb1-49ae-86c1-7da5cf2f6a18, IP=127.0.0.1, \u65b9\u6cd5=POST, \u8def\u5f84=/api/auth/login, \u72b6\u6001\u7801=200, \u8017\u65f6=92.55ms\n2026-01-30 18:21:09 [    INFO] HTTP Request: POST http://test/api/auth/login "HTTP/1.1 200 OK"
PASSED                                                                   [ 20%]
tests/integration/test_auth_router.py::TestAuthRouter::test_login_invalid_credentials 
-------------------------------- live log call --------------------------------
2026-01-30 18:21:09 [    INFO] \U0001f310 [WebAPI] \u8bf7\u6c42\u5f00\u59cb: TraceID=a5386d1e-0434-4aff-859d-3809a102597b, IP=127.0.0.1, \u65b9\u6cd5=GET, \u8def\u5f84=/\n2026-01-30 18:21:09 [    INFO] \u2705 [WebAPI] \u8bf7\u6c42\u5b8c\u6210: TraceID=a5386d1e-0434-4aff-859d-3809a102597b, IP=127.0.0.1, \u65b9\u6cd5=GET, \u8def\u5f84=/, \u72b6\u6001\u7801=200, \u8017\u65f6=0.58ms\n2026-01-30 18:21:09 [    INFO] HTTP Request: GET http://test/ "HTTP/1.1 200 OK"
2026-01-30 18:21:09 [    INFO] \U0001f310 [WebAPI] \u8bf7\u6c42\u5f00\u59cb: TraceID=febf884a-ebb9-4b97-a81c-74b49e82f725, IP=127.0.0.1, \u65b9\u6cd5=POST, \u8def\u5f84=/api/auth/login\n2026-01-30 18:21:09 [    INFO] \U0001f510 [Auth] \u7528\u6237\u8ba4\u8bc1\u8bf7\u6c42: \u7528\u6237\u540d=wrong\n2026-01-30 18:21:09 [ WARNING] \u26a0\ufe0f [Auth] \u7528\u6237\u8ba4\u8bc1\u5931\u8d25: \u7528\u6237\u540d\u4e0d\u5b58\u5728\uff0c\u7528\u6237\u540d=wrong\n2026-01-30 18:21:09 [ WARNING] 登录失败: username=wrong, ip=127.0.0.1, attempts=1/5
2026-01-30 18:21:09 [    INFO] \u2705 [WebAPI] \u8bf7\u6c42\u5b8c\u6210: TraceID=febf884a-ebb9-4b97-a81c-74b49e82f725, IP=127.0.0.1, \u65b9\u6cd5=POST, \u8def\u5f84=/api/auth/login, \u72b6\u6001\u7801=401, \u8017\u65f6=2.42ms\n2026-01-30 18:21:09 [    INFO] HTTP Request: POST http://test/api/auth/login "HTTP/1.1 401 Unauthorized"
PASSED                                                                   [ 40%]
tests/integration/test_auth_router.py::TestAuthRouter::test_register_flow 
-------------------------------- live log call --------------------------------
2026-01-30 18:21:09 [    INFO] \U0001f310 [WebAPI] \u8bf7\u6c42\u5f00\u59cb: TraceID=49e5f352-dc67-4472-99c2-5271707dd110, IP=127.0.0.1, \u65b9\u6cd5=GET, \u8def\u5f84=/\n2026-01-30 18:21:09 [    INFO] \u2705 [WebAPI] \u8bf7\u6c42\u5b8c\u6210: TraceID=49e5f352-dc67-4472-99c2-5271707dd110, IP=127.0.0.1, \u65b9\u6cd5=GET, \u8def\u5f84=/, \u72b6\u6001\u7801=200, \u8017\u65f6=0.59ms\n2026-01-30 18:21:09 [    INFO] HTTP Request: GET http://test/ "HTTP/1.1 200 OK"
2026-01-30 18:21:09 [    INFO] \U0001f310 [WebAPI] \u8bf7\u6c42\u5f00\u59cb: TraceID=3dd0c742-b71d-405d-b366-6857266c9a0a, IP=127.0.0.1, \u65b9\u6cd5=POST, \u8def\u5f84=/api/auth/register\n2026-01-30 18:21:09 [    INFO] New user registered: username=newuser
2026-01-30 18:21:09 [    INFO] \u2705 [WebAPI] \u8bf7\u6c42\u5b8c\u6210: TraceID=3dd0c742-b71d-405d-b366-6857266c9a0a, IP=127.0.0.1, \u65b9\u6cd5=POST, \u8def\u5f84=/api/auth/register, \u72b6\u6001\u7801=200, \u8017\u65f6=89.39ms\n2026-01-30 18:21:09 [    INFO] HTTP Request: POST http://test/api/auth/register "HTTP/1.1 200 OK"
PASSED                                                                   [ 60%]
tests/integration/test_auth_router.py::TestAuthRouter::test_logout 
-------------------------------- live log call --------------------------------
2026-01-30 18:21:09 [    INFO] \U0001f310 [WebAPI] \u8bf7\u6c42\u5f00\u59cb: TraceID=f155cf32-6f31-4152-933a-a46ab626ff0d, IP=127.0.0.1, \u65b9\u6cd5=GET, \u8def\u5f84=/\n2026-01-30 18:21:09 [    INFO] \u2705 [WebAPI] \u8bf7\u6c42\u5b8c\u6210: TraceID=f155cf32-6f31-4152-933a-a46ab626ff0d, IP=127.0.0.1, \u65b9\u6cd5=GET, \u8def\u5f84=/, \u72b6\u6001\u7801=200, \u8017\u65f6=0.52ms\n2026-01-30 18:21:09 [    INFO] HTTP Request: GET http://test/ "HTTP/1.1 200 OK"
2026-01-30 18:21:09 [    INFO] \U0001f310 [WebAPI] \u8bf7\u6c42\u5f00\u59cb: TraceID=6c2fa87e-5da4-40ad-90b6-f65f86139b42, IP=127.0.0.1, \u65b9\u6cd5=POST, \u8def\u5f84=/api/auth/logout\n2026-01-30 18:21:09 [    INFO] \u2705 [WebAPI] \u8bf7\u6c42\u5b8c\u6210: TraceID=6c2fa87e-5da4-40ad-90b6-f65f86139b42, IP=127.0.0.1, \u65b9\u6cd5=POST, \u8def\u5f84=/api/auth/logout, \u72b6\u6001\u7801=200, \u8017\u65f6=1.32ms\n2026-01-30 18:21:09 [    INFO] HTTP Request: POST http://test/api/auth/logout "HTTP/1.1 200 OK"
PASSED                                                                   [ 80%]
tests/integration/test_auth_router.py::TestAuthRouter::test_refresh_token 
-------------------------------- live log call --------------------------------
2026-01-30 18:21:09 [ WARNING] CSRF token validation failed for POST /api/auth/login: CSRF Token Verification Failed
2026-01-30 18:21:09 [    INFO] HTTP Request: POST http://test/api/auth/login "HTTP/1.1 403 Forbidden"
FAILED                                                                   [100%]

================================== FAILURES ===================================
______________________ TestAuthRouter.test_refresh_token ______________________
tests\integration\test_auth_router.py:74: in test_refresh_token
    refresh_token = login_resp.json()["refresh_token"]
                    ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   KeyError: 'refresh_token'
------------------------------ Captured log call ------------------------------
WARNING  web_admin.security.csrf:csrf.py:34 CSRF token validation failed for POST /api/auth/login: CSRF Token Verification Failed
INFO     httpx:_client.py:1740 HTTP Request: POST http://test/api/auth/login "HTTP/1.1 403 Forbidden"
=========================== short test summary info ===========================
FAILED tests/integration/test_auth_router.py::TestAuthRouter::test_refresh_token - KeyError: 'refresh_token'
========================= 1 failed, 4 passed in 1.35s =========================
