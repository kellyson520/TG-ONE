from typing import Dict, Any, List
from telethon.tl.custom import Button
from .base_renderer import BaseRenderer, ViewResult
from ui.constants import UIStatus

class MediaRenderer(BaseRenderer):
    """åª’ä½“ã€AI ä¸å†å²ä»»åŠ¡æ¸²æŸ“å™¨ (UIRE-2.0)"""

    def render_history_hub(self, data: Dict[str, Any]) -> ViewResult:
        """æ¸²æŸ“å†å²æ¶ˆæ¯è¿ç§»ä¸­å¿ƒ"""
        current_task = data.get('current_task')
        builder = self.new_builder()
        builder.set_title("å†å²æ¶ˆæ¯è¿ç§»ä¸­å¿ƒ", icon="è¡¥å…¨")
        builder.add_breadcrumb(["é¦–é¡µ", "å†å²ä¸­å¿ƒ"])
        builder.add_section("æœåŠ¡è¯´æ˜", "æ‚¨å¯ä»¥å°†æŒ‡å®šæ—¶é—´èŒƒå›´å†…çš„å†å²æ¶ˆæ¯æŒ‰ç…§ç°æœ‰è§„åˆ™è¿›è¡Œé‡å‘ã€è¿‡æ»¤æˆ–åŒæ­¥ã€‚")
        
        if current_task:
            processed = current_task.get('processed', 0)
            total = current_task.get('total', 1) # é˜²æ­¢é™¤é›¶
            percent = (processed / total) * 100
            
            builder.add_section("å½“å‰æ´»è·ƒä»»åŠ¡", [], icon=UIStatus.SYNC)
            builder.add_progress_bar("è¿ç§»è¿›åº¦", percent)
            builder.add_status_grid({
                "ä»»åŠ¡çŠ¶æ€": (current_task.get('status', 'è¿è¡Œä¸­'), UIStatus.PROGRESS),
                "å·²å¤„ç†": f"{processed} / {total}"
            })
        else:
            builder.add_section("ä»»åŠ¡çŠ¶æ€", "å½“å‰æ— æ´»è·ƒè¿ç§»ä»»åŠ¡ã€‚", icon=UIStatus.INFO)
            
        builder.add_button("å¼€å¯è¡¥å…¨ä»»åŠ¡", action="new_menu:history_task_selector", icon=UIStatus.ADD)
        builder.add_button("ä»»åŠ¡å†å²", action="new_menu:history_task_list", icon=UIStatus.SEARCH)
        builder.add_button("åª’ä½“ç±»å‹è®¾ç½®", action="new_menu:media_filter_config", icon=UIStatus.SETTINGS)
        builder.add_button("AI å¢å¼ºé€‰é¡¹", action="new_menu:ai_global_settings", icon=UIStatus.DOT)
        builder.add_button("è¿”å›ä¸»èœå•", action="new_menu:main_menu", icon=UIStatus.BACK)
        
        return builder.build()

    def render_history_task_actions(self, data: Dict[str, Any]) -> ViewResult:
        """æ¸²æŸ“å†å²ä»»åŠ¡æ“ä½œé…ç½®é¡µé¢"""
        selected = data.get('selected', {})
        dedup = data.get('dedup_enabled', False)
        
        return (self.new_builder()
            .set_title("å†å²è¿ç§»ä»»åŠ¡é…ç½®", icon="ğŸš€")
            .add_breadcrumb(["é¦–é¡µ", "è¡¥å…¨ä¸­å¿ƒ", "ä»»åŠ¡é¢„è§ˆ"])
            .add_section("æ ¸å¿ƒé…ç½®é¡¹", [], icon="ğŸ“")
            .add_status_grid({
                "ç›®æ ‡è§„åˆ™": selected.get('id', 'æœªé€‰æ‹©'),
                "æ—¶é—´èŒƒå›´": data.get('time_range', 'æœªè®¾ç½®'),
                "æ™ºèƒ½å»é‡": ("å·²å¼€å¯", UIStatus.SUCCESS) if dedup else ("å·²å…³é—­", UIStatus.ERROR)
            })
            .add_section("æ“ä½œå¼•å¯¼", "ç¡®è®¤æ— è¯¯åç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¼€å§‹ä»»åŠ¡ã€‚", icon="ğŸ’¡")
            .add_button("å¼€å§‹æ‰§è¡Œ", action="new_menu:start_history_task", icon="ğŸš€")
            .add_button("åœæ­¢/æ¸…ç†", action="new_menu:cancel_history_task", icon="â¹ï¸")
            .add_button("è®¾ç½®æ—¶é—´èŒƒå›´", action="new_menu:history_time_range", icon=UIStatus.CLOCK)
            .add_button("åˆ‡æ¢å»é‡", action="new_menu:toggle_history_dedup", icon=UIStatus.SYNC)
            .add_button("è¿”å›å†å²ä¸­å¿ƒ", action="new_menu:history_messages", icon=UIStatus.BACK)
            .build())

    def render_media_filter_config(self, data: Dict[str, Any]) -> ViewResult:
        """æ¸²æŸ“åª’ä½“è½¬å‘è¿‡æ»¤çŸ©é˜µ (Phase 2.2)"""
        settings = data.get('settings', {})
        
        builder = self.new_builder()
        builder.set_title("åª’ä½“è½¬å‘è¿‡æ»¤çŸ©é˜µ", icon="ğŸ¬")
        builder.add_breadcrumb(["é¦–é¡µ", "è¡¥å…¨ä¸­å¿ƒ", "åª’ä½“è¿‡æ»¤"])
        builder.add_section("é…ç½®è¯´æ˜", "æ­¤å¤„è®¾ç½®å½±å“â€˜å†å²è¡¥å…¨â€™ä»»åŠ¡ä¸­çš„é»˜è®¤åª’ä½“è¿‡æ»¤è¡Œä¸ºã€‚", icon=UIStatus.INFO)
        
        # åª’ä½“ç±»å‹çŠ¶æ€æ˜ å°„
        types = {
            "photo": ("å›¾ç‰‡", "ğŸ–¼ï¸"),
            "video": ("è§†é¢‘", "ğŸ¬"),
            "document": ("æ–‡æ¡£", "ğŸ“„"),
            "audio": ("éŸ³é¢‘", "ğŸµ"),
            "voice": ("è¯­éŸ³", "ğŸ™ï¸"),
            "sticker": ("è¡¨æƒ…", "ğŸˆ")
        }
        
        status_lines = []
        for key, (label, icon) in types.items():
            enabled = settings.get(f"allow_{key}", True)
            status = "âœ… å…è®¸" if enabled else "âŒ è¿‡æ»¤"
            status_lines.append(f"{icon} {label}: {status}")
            builder.add_button(f"{label} {'ğŸ”´' if enabled else 'ğŸŸ¢'}", f"toggle_global_media:{key}")
            
        builder.add_section("å…¨å±€é…ç½®çŸ©é˜µ", status_lines, icon=UIStatus.SETTINGS)
        
        builder.add_button("é«˜çº§æ‰©å±•åè¿‡æ»¤", action="new_menu:media_extension_hub", icon="ğŸ§ª")
        builder.add_button("è¿”å›è¡¥å…¨ä¸­å¿ƒ", action="new_menu:history_messages", icon=UIStatus.BACK)
        
        return builder.build()

    def render_ai_global_settings(self, data: Dict[str, Any]) -> ViewResult:
        """æ¸²æŸ“ AI å¢å¼ºå…¨å±€è®¾ç½® (Phase 2.2)"""
        settings = data.get('settings', {})
        
        builder = self.new_builder()
        builder.set_title("AI å¢å¼ºå…¨å±€é¢æ¿", icon="ğŸ¤–")
        builder.add_breadcrumb(["é¦–é¡µ", "è¡¥å…¨ä¸­å¿ƒ", "AIè®¾ç½®"])
        
        builder.add_section("æœåŠ¡å·¡æ£€", "ç®¡ç†ç³»ç»Ÿçº§ AI é¢„å¤„ç†å™¨å’Œåå¤„ç†é’©å­çŠ¶æ€ã€‚", icon="ğŸ§ ")
        
        builder.add_status_grid({
            "é»˜è®¤æ¨¡å‹": settings.get('default_model', 'GPT-4o'),
            "å¹¶å‘é™åˆ¶": f"{settings.get('ai_concurrency', 5)} æ¡/ç§’",
            "é‡è¯•æ¬¡æ•°": f"{settings.get('ai_retries', 3)} æ¬¡"
        })
        
        builder.add_section("å…¨å±€ç­–ç•¥", [
            f"â€¢ å…œåº•å¤„ç†: {'è½¬å‘åŸæ¶ˆæ¯' if settings.get('ai_fallback') == 'raw' else 'ç›´æ¥å¿½ç•¥'}",
            f"â€¢ æ•æ„Ÿè¯æ‹¦æˆª: {'å¼€å¯' if settings.get('enable_safety') else 'å…³é—­'}"
        ], icon="ğŸ›¡ï¸")
        
        builder.add_button("é»˜è®¤æ¨¡å‹é€‰æ‹©", action="new_menu:ai_global_model", icon="ğŸ§ ")
        builder.add_button("å¹¶å‘é…é¢è®¾ç½®", action="new_menu:ai_global_concurrency", icon="âš¡")
        builder.add_button("è¿”å›è¡¥å…¨ä¸­å¿ƒ", action="new_menu:history_messages", icon=UIStatus.BACK)
        
        return builder.build()

    def render_ai_settings(self, data: Dict[str, Any]) -> ViewResult:
        """æ¸²æŸ“ AI å¢å¼ºè®¾ç½®é¡µé¢ (Phase 4.5)"""
        rule = data.get('rule', {}) or data # å…¼å®¹æ€§å¤„ç†
        rid = rule.get('id', 'Unknown')
        is_ai = rule.get('is_ai', False)
        is_sum = rule.get('is_summary', False)
        
        builder = self.new_builder()
        builder.set_title(f"AI å¢å¼ºè®¾ç½® - {rid}", icon="ğŸ¤–")
        builder.add_breadcrumb(["é¦–é¡µ", "è½¬å‘", f"AI-{rid}"])
        
        builder.add_section("æ ¸å¿ƒå¼€å…³", [], icon="âš¡")
        builder.add_status_grid({
            "AI å¢å¼ºå¤„ç†": ("å¯ç”¨" if is_ai else "å…³é—­", UIStatus.SUCCESS if is_ai else UIStatus.ERROR),
            "AI è‡ªåŠ¨æ€»ç»“": ("å¯ç”¨" if is_sum else "å…³é—­", UIStatus.SUCCESS if is_sum else UIStatus.ERROR)
        })
        
        if is_ai:
            builder.add_section("å¤„ç†é€»è¾‘", [], icon="ğŸ§ ")
            builder.add_status_grid({
                "åŸºç¡€æ¨¡å‹": rule.get('ai_model', 'é»˜è®¤'),
                "å›¾ç‰‡ä¸Šä¼ ": ("æ˜¯" if rule.get('enable_ai_upload_image') else "å¦", UIStatus.INFO),
                "åç½®è¿‡æ»¤": ("å¼€å¯" if rule.get('is_keyword_after_ai') else "å…³é—­", UIStatus.INFO)
            })
            builder.add_button("åˆ‡æ¢æ¨¡å‹", f"change_model:{rid}", icon="ğŸ§ ")
            builder.add_button("è®¾ç½®æç¤ºè¯", f"set_ai_prompt:{rid}", icon="âœï¸")
            builder.add_button(f"{'âœ…' if rule.get('enable_ai_upload_image') else 'âŒ'} ä¼ å›¾", f"toggle_ai_upload_image:{rid}")
            builder.add_button(f"{'âœ…' if rule.get('is_keyword_after_ai') else 'âŒ'} åæ»¤", f"toggle_keyword_after_ai:{rid}")

        if is_sum:
            builder.add_section("æ€»ç»“é…ç½®", [], icon="ğŸ“‹")
            builder.add_status_grid({
                "æ€»ç»“å‘¨æœŸ": rule.get('summary_time', '00:00'),
                "é¡¶ç½®æ¶ˆæ¯": ("æ˜¯" if rule.get('is_top_summary') else "å¦", UIStatus.INFO)
            })
            builder.add_button("æ€»ç»“é¢‘ç‡", f"set_summary_time:{rid}", icon="â°")
            builder.add_button("æ€»ç»“æç¤ºè¯", f"set_summary_prompt:{rid}", icon="âœï¸")
            builder.add_button(f"{'âœ…' if rule.get('is_top_summary') else 'âŒ'} é¡¶ç½®", f"toggle_top_summary:{rid}")
            builder.add_button("ç«‹å³æ€»ç»“", f"summary_now:{rid}", icon="ğŸš€")

        builder.add_button(f"{'ğŸ”´ å…³é—­ AI' if is_ai else 'ğŸŸ¢ å¼€å¯ AI'}", f"toggle_ai:{rid}")
        builder.add_button(f"{'ğŸ”´ å…³é—­æ€»ç»“' if is_sum else 'ğŸŸ¢ å¼€å¯æ€»ç»“'}", f"toggle_summary:{rid}")
        builder.add_button("è¿”å›è§„åˆ™è®¾ç½®", f"settings:{rid}", icon=UIStatus.BACK)
        return builder.build()

    def render_ai_prompt_editor(self, data: Dict[str, Any]) -> ViewResult:
        """æ¸²æŸ“ AI æç¤ºè¯ç¼–è¾‘å™¨"""
        rid = data.get('rule_id')
        p_type = data.get('type', 'å¤„ç†')
        current = data.get('current_prompt', 'æœªè®¾ç½®')
        
        return (self.new_builder()
            .set_title(f"ç¼–è¾‘ AI {p_type}æç¤ºè¯", icon="âœï¸")
            .add_section("å½“å‰æç¤ºè¯", f"`{current}`", icon="ğŸ“")
            .add_section("æ“ä½œæŒ‡å¼•", f"è¯·ç›´æ¥åœ¨å¯¹è¯æ¡†è¾“å…¥æ–°çš„ AI {p_type}æç¤ºè¯ã€‚æ”¯æŒ Markdown æ ¼å¼ã€‚è¾“å…¥ `å–æ¶ˆ` é€€å‡ºã€‚")
            .add_button("å–æ¶ˆä¿®æ”¹", f"new_menu:cancel_set_prompt:{rid}", icon=UIStatus.ERROR)
            .build())

    def render_model_selection(self, data: Dict[str, Any]) -> ViewResult:
        """æ¸²æŸ“æ¨¡å‹é€‰æ‹©é¡µé¢"""
        rid = data.get('rule_id')
        models = data.get('models', [])
        current = data.get('current_model')
        
        builder = self.new_builder()
        builder.set_title("é€‰æ‹© AI å¼•æ“", icon="ğŸ§ ")
        builder.add_section("å½“å‰é€‰æ‹©", f"`{current or 'é»˜è®¤æ ¸å¿ƒ'}`", icon="ğŸ¯")
        
        for model in models:
            builder.add_button(f"{'âœ… ' if model == current else ''}{model}", f"select_ai_model:{rid}:{model}")
            
        builder.add_button("è¿”å› AI è®¾ç½®", f"ai_settings:{rid}", icon=UIStatus.BACK)
        return builder.build()

    def render_summary_time_selection(self, data: Dict[str, Any]) -> ViewResult:
        """æ¸²æŸ“æ€»ç»“æ—¶é—´é€‰æ‹©é¡µé¢"""
        rid = data.get('rule_id')
        current = data.get('current_time', '00:00')
        
        builder = self.new_builder()
        builder.set_title("è®¾ç½®æ€»ç»“æ—¶é—´", icon="â°")
        builder.add_section("æç¤º", "AI æ¯æ—¥å°†åœ¨é€‰å®šæ—¶é—´ç‚¹æ±‡æ€»è¯¥è§„åˆ™ä¸‹è½¬å‘çš„æ‰€æœ‰å†…å®¹ã€‚")
        
        # å¸¸è§æ—¶é—´ç‚¹
        times = ["00:00", "08:00", "12:00", "18:00", "22:00", "23:59"]
        for t in times:
            builder.add_button(f"{'ğŸ¯ ' if t == current else ''}{t}", f"select_summary_time:{rid}:{t}")
            
        builder.add_button("è¿”å› AI è®¾ç½®", f"ai_settings:{rid}", icon=UIStatus.BACK)
        return builder.build()

    def render_media_extension_hub(self, data: Dict[str, Any]) -> ViewResult:
        """æ¸²æŸ“é«˜çº§æ‰©å±•åè¿‡æ»¤ä¸­å¿ƒ (Phase 2.2)"""
        selected = data.get('selected', [])
        options = data.get('options', [])
        
        builder = self.new_builder()
        builder.set_title("é«˜çº§åª’ä½“æ‰©å±•åè¿‡æ»¤", icon="ğŸ§ª")
        builder.add_breadcrumb(["é¦–é¡µ", "è¡¥å…¨ä¸­å¿ƒ", "æ‰©å±•å"])
        
        builder.add_section("ç”Ÿæ•ˆæœºåˆ¶", "é€‰ä¸­çš„æ‰©å±•åå°†åœ¨å†å²è¡¥å…¨ä»»åŠ¡ä¸­è¢«**æ‹¦æˆª**ã€‚", icon=UIStatus.INFO)
        
        # åˆ†é¡µæ˜¾ç¤ºé€»è¾‘å¯ä»¥åœ¨ Controller å¤„ç†ï¼Œè¿™é‡Œç®€å•æ˜¾ç¤º
        for ext in options:
            is_selected = ext in selected
            builder.add_button(f"{'âœ…' if is_selected else 'â¬œ'} .{ext}", f"toggle_global_extension:{ext}")
            
        builder.add_button("è¿”å›åª’ä½“è¿‡æ»¤", action="new_menu:media_filter_config", icon=UIStatus.BACK)
        return builder.build()

    def render_ai_global_model_selection(self, data: Dict[str, Any]) -> ViewResult:
        """æ¸²æŸ“ AI å…¨å±€é»˜è®¤æ¨¡å‹é€‰æ‹©"""
        models = data.get('models', [])
        current = data.get('current_model')
        
        builder = self.new_builder()
        builder.set_title("å…¨å±€é»˜è®¤ AI å¼•æ“", icon="ğŸ§ ")
        builder.add_section("å½“å‰å…¨å±€é»˜è®¤", f"`{current or 'æ ¸å¿ƒé»˜è®¤'}`", icon="ğŸ¯")
        
        for model in models:
            builder.add_button(f"{'âœ… ' if model == current else ''}{model}", f"select_global_ai_model:{model}")
            
        builder.add_button("è¿”å› AI è®¾ç½®", action="new_menu:ai_global_settings", icon=UIStatus.BACK)
        return builder.build()

    def render_ai_global_concurrency_settings(self, data: Dict[str, Any]) -> ViewResult:
        """æ¸²æŸ“ AI å…¨å±€å¹¶å‘é…é¢è®¾ç½®"""
        current = data.get('current_concurrency', 5)
        
        builder = self.new_builder()
        builder.set_title("AI æ™ºèƒ½å¹¶å‘ç­–ç•¥", icon="âš¡")
        builder.add_section("å½“å‰é…é¢", f"`{current}` æ¡/ç§’", icon="ğŸ”¥")
        builder.add_section("ç­–ç•¥è¯´æ˜", "å¢åŠ å¹¶å‘å¯æå‡è¡¥å…¨é€Ÿåº¦ï¼Œä½†å¯èƒ½é¢ä¸´ä¸Šæ¸¸ API é¢‘ç‡é™åˆ¶ (429) é£é™©ã€‚", icon="ğŸ’¡")
        
        options = [1, 2, 3, 5, 10, 20]
        for opt in options:
            builder.add_button(f"{'ğŸ¯ ' if opt == current else ''}{opt} æ¡/ç§’", f"set_global_ai_concurrency:{opt}")
            
        builder.add_button("è¿”å› AI è®¾ç½®", action="new_menu:ai_global_settings", icon=UIStatus.BACK)
        return builder.build()
