============================= test session starts =============================
platform win32 -- Python 3.13.0, pytest-9.0.1, pluggy-1.6.0 -- E:\python\python313\python.exe
cachedir: tests\temp\.pytest_cache
hypothesis profile 'default'
rootdir: E:\重构\TG ONE
configfile: pytest.ini
plugins: anyio-4.12.1, hypothesis-6.151.4, asyncio-1.3.0, cov-7.0.0, mock-3.15.1, xdist-3.8.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... 
----------------------------- live log collection -----------------------------
2026-02-07 16:50:23 [ WARNING] 已忽略预期内的异常: env PROMETHEUS_MULTIPROC_DIR is not set or not a directory
2026-02-07 16:50:23 [    INFO] 去重引擎基础设施完成 (Bloom/HLL/SimHash)
2026-02-07 16:50:23 [    INFO] Bloom Filter Service initialized using consolidated utils implementation
collected 7 items

tests/unit/services/test_dedup_service.py::TestDedupService::test_get_dedup_config 
------------------------------- live log setup --------------------------------
2026-02-07 16:50:23 [    INFO] [Database] 初始化数据库连接，模式=共享引擎
2026-02-07 16:50:23 [    INFO] [Database] 使用共享引擎: sqlite+aiosqlite:///file:testdb_master?cache=shared&mode=memory&uri=true
2026-02-07 16:50:23 [    INFO] [Database] 会话工厂已初始化
2026-02-07 16:50:23 [    INFO] Container connected to shared database engine: sqlite+aiosqlite:///file:testdb_master?cache=shared&mode=memory&uri=true
2026-02-07 16:50:23 [    INFO] EventBus initialized
PASSED                                                                   [ 14%]
tests/unit/services/test_dedup_service.py::TestDedupService::test_update_config PASSED [ 28%]
tests/unit/services/test_dedup_service.py::TestDedupService::test_toggle_feature PASSED [ 42%]
tests/unit/services/test_dedup_service.py::TestDedupService::test_set_time_window PASSED [ 57%]
tests/unit/services/test_dedup_service.py::TestDedupService::test_clear_all_cache PASSED [ 71%]
tests/unit/services/test_dedup_service.py::TestDedupService::test_record_signature SKIPPED [ 85%]
tests/unit/services/test_dedup_service.py::TestDedupService::test_is_duplicate FAILED [100%]

================================== FAILURES ===================================
_____________________ TestDedupService.test_is_duplicate ______________________
tests\unit\services\test_dedup_service.py:100: in test_is_duplicate
    is_dup = await dedup_service.is_duplicate(1001, message)
             ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
services\dedup_service.py:235: in is_duplicate
    is_dup, reason = await smart_deduplicator.check_duplicate(
services\dedup\engine.py:188: in check_duplicate
    res = await strategy.process(ctx)
          ^^^^^^^^^^^^^^^^^^^^^^^^^^^
services\dedup\strategies\video.py:67: in process
    if size > config.get('video_partial_hash_min_size_bytes', 5*1024*1024):
       ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E   TypeError: '>' not supported between instances of 'MagicMock' and 'int'
=========================== short test summary info ===========================
FAILED tests/unit/services/test_dedup_service.py::TestDedupService::test_is_duplicate - TypeError: '>' not supported between instances of 'MagicMock' and 'int'
=================== 1 failed, 5 passed, 1 skipped in 0.39s ====================
