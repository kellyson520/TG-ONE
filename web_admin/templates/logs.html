{% extends "base.html" %}
{% block title %}日志中心 - Forwarder Pro{% endblock %}
{% block content %}

<div class="row mb-4">
  <div class="col-12">
    <h4 class="fw-bold mb-0">日志中心</h4>
    <p class="text-muted small">实时查看系统运行状态及错误日志</p>
  </div>
</div>

<div class="row g-4">
  <!-- 日志文件列表 -->
  <div class="col-lg-3">
    <div class="glass-card h-100 p-4">
      <h6 class="fw-bold mb-3"><i class="bi bi-files me-2"></i>日志文件</h6>
      <div id="fileList" class="d-grid gap-2">
        <div class="text-center py-4 text-muted small">加载中心...</div>
      </div>
    </div>
  </div>

  <!-- 日志内容 -->
  <div class="col-lg-9">
    <div class="glass-card h-100 p-4">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4 pb-3 border-bottom">
        <h6 class="fw-bold mb-0">
          <i class="bi bi-terminal me-2"></i>
          <span id="currentFileName">app.log</span>
        </h6>
        <div class="d-flex gap-2">
          <div id="wsStatusDot" class="status-dot offline me-2 d-none d-md-block" title="实时连接状态"></div>
          <select class="form-select form-select-sm" id="logLevel" style="width: auto;">
            <option value="">所有级别</option>
            <option value="ERROR">错误</option>
            <option value="WARNING">警告</option>
            <option value="INFO">信息</option>
            <option value="DEBUG">调试</option>
          </select>
          <div class="input-group input-group-sm" style="width: 200px;">
            <span class="input-group-text bg-transparent border-end-0"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control border-start-0" id="logSearch" placeholder="搜索内容...">
          </div>
          <button id="pauseBtn" class="btn btn-sm btn-warning-light" title="暂停/恢复实时流">
            <i class="bi bi-pause-fill"></i>
          </button>
          <button id="scrollBtn" class="btn btn-sm btn-outline-secondary active" title="自动滚动">
            <i class="bi bi-arrow-down-circle-fill"></i>
          </button>
          <button id="clearBtn" class="btn btn-sm btn-outline-danger" title="清空视图">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>

      <div id="logViewer" class="log-viewer-modern">
        <div class="text-center py-5 text-muted">
          <i class="bi bi-file-earmark-text d-block fs-1 mb-3 opacity-25"></i>
          选择日志文件以查看
        </div>
      </div>
    </div>
  </div>

  <!-- 数据库日志 -->
  <div class="col-12">
    <div class="glass-card p-4">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h6 class="fw-bold mb-0"><i class="bi bi-database me-2"></i>数据库记录</h6>
        <button class="btn btn-sm btn-outline-secondary px-3" onclick="loadDbLogs()">
          <i class="bi bi-arrow-down-circle me-1"></i> 加载记录
        </button>
      </div>
      <div class="table-responsive">
        <table class="table table-hover table-sm small align-middle">
          <thead>
            <tr class="text-muted">
              <th width="80">ID</th>
              <th width="180">时间</th>
              <th width="100">级别</th>
              <th width="150">模块</th>
              <th>消息</th>
            </tr>
          </thead>
          <tbody id="dbLogsBody">
            <tr>
              <td colspan="5" class="text-center py-4 text-muted">待加载...</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  let currentFile = 'app.log';
  let allLogs = [];
  let wsConnected = false;
  let isStreamPaused = false;
  let autoScroll = true;
  const MAX_LOG_LINES = 5000; // 内存中保留的最大日志行数

  document.addEventListener('DOMContentLoaded', () => {
    loadFileList();
    refreshLogs();
    loadDbLogs();
    initWebSocket();
    setupLogViewerEvents();
  });

  // ========== WebSocket 实时日志 ==========

  function initWebSocket() {
    if (!window.wsManager) {
      console.warn('[Logs] WebSocket not available');
      return;
    }

    wsManager.connect();

    wsManager.onConnect(() => {
      wsConnected = true;
      console.log('[Logs] WebSocket connected, subscribing to logs');
      wsManager.subscribe('logs', handleLogMessage);
      updateStreamStatus();
    });

    wsManager.onDisconnect(() => {
      wsConnected = false;
      updateStreamStatus();
    });
  }

  function handleLogMessage(message) {
    if (isStreamPaused) return;

    // 简单的日志行过滤 (只显示当前文件的日志，这里假设所有日志都来自 app.log)
    if (currentFile !== 'app.log') return;

    if (message.type === 'log') {
      const logLine = formatLogLineFromMsg(message);
      appendLogLine(logLine);
    }
  }

  function formatLogLineFromMsg(msg) {
    // 模拟标准日志格式: YYYY-MM-DD HH:mm:ss [LEVEL] Message
    const timestamp = new Date().toISOString().replace('T', ' ').substring(0, 19);
    return `${timestamp} [${msg.level.toUpperCase()}] ${msg.message}`;
  }

  function appendLogLine(line) {
    // 内存限制
    if (allLogs.length >= MAX_LOG_LINES) {
      allLogs.shift(); // 移除最早的一行
    }
    allLogs.push(line);

    // 如果当前应用了过滤器，需要检查新行是否匹配
    const level = document.getElementById('logLevel').value;
    const search = document.getElementById('logSearch').value.toLowerCase();

    const matchLevel = !level || line.includes(level);
    const matchSearch = !search || line.toLowerCase().includes(search);

    if (matchLevel && matchSearch) {
      const viewer = document.getElementById('logViewer');
      const contentArea = viewer.querySelector('.log-content-area');

      if (contentArea) {
        // 解析日志级别以应用颜色
        let typeClass = 'info';
        if (line.includes('ERROR') || line.includes('CRITICAL')) typeClass = 'danger';
        else if (line.includes('WARNING')) typeClass = 'warning';
        else if (line.includes('DEBUG')) typeClass = 'secondary';

        const lineHtml = `<div class="log-line-new border-start border-3 border-${typeClass}">${safeHtml(line)}</div>`;
        contentArea.insertAdjacentHTML('beforeend', lineHtml);

        // 限制 DOM 节点数量，移除顶部的节点以防止页面崩溃
        if (contentArea.children.length > MAX_LOG_LINES) {
          contentArea.removeChild(contentArea.firstElementChild);
        }
      } else {
        renderLogLines(); // 首次渲染
      }

      if (autoScroll) {
        requestAnimationFrame(scrollToBottom);
      }
    }
  }

  function setupLogViewerEvents() {
    const viewer = document.getElementById('logViewer');

    // 监听滚动事件，判断是否需要自动滚动
    viewer.addEventListener('scroll', () => {
      // 如果用户向上滚动了一点距离，则停止自动滚动
      // 阈值设为 50px
      const isNearBottom = viewer.scrollHeight - viewer.scrollTop - viewer.clientHeight < 50;

      if (!isNearBottom && autoScroll) {
        autoScroll = false;
        updateAutoScrollBtn();
      } else if (isNearBottom && !autoScroll) {
        autoScroll = true;
        updateAutoScrollBtn();
      }
    });

    // 绑定按钮事件
    const pauseBtn = document.getElementById('pauseBtn');
    if (pauseBtn) pauseBtn.addEventListener('click', togglePause);

    const scrollBtn = document.getElementById('scrollBtn');
    if (scrollBtn) scrollBtn.addEventListener('click', toggleAutoScroll);

    const clearBtn = document.getElementById('clearBtn');
    if (clearBtn) clearBtn.addEventListener('click', clearLogs);
  }

  function togglePause() {
    isStreamPaused = !isStreamPaused;
    const btn = document.getElementById('pauseBtn');
    if (isStreamPaused) {
      btn.innerHTML = '<i class="bi bi-play-fill"></i>';
      btn.className = 'btn btn-sm btn-success-light';
      btn.title = "恢复实时流";
    } else {
      btn.innerHTML = '<i class="bi bi-pause-fill"></i>';
      btn.className = 'btn btn-sm btn-warning-light';
      btn.title = "暂停实时流";
    }
  }

  function toggleAutoScroll() {
    autoScroll = !autoScroll;
    updateAutoScrollBtn();
    if (autoScroll) scrollToBottom();
  }

  function updateAutoScrollBtn() {
    const btn = document.getElementById('scrollBtn');
    if (autoScroll) {
      btn.classList.add('active');
      btn.innerHTML = '<i class="bi bi-arrow-down-circle-fill"></i>';
    } else {
      btn.classList.remove('active');
      btn.innerHTML = '<i class="bi bi-arrow-down-circle"></i>';
    }
  }

  function scrollToBottom() {
    const viewer = document.getElementById('logViewer');
    viewer.scrollTop = viewer.scrollHeight;
  }

  function clearLogs() {
    allLogs = [];
    renderLogLines();
  }

  function updateStreamStatus() {
    const statusDot = document.getElementById('wsStatusDot');
    if (!statusDot) return;
    statusDot.className = wsConnected ? 'status-dot online me-2 d-none d-md-block' : 'status-dot offline me-2 d-none d-md-block';
  }

  function safeHtml(str) {
    return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
  }

  // ========== 常规 API 逻辑 ==========

  async function loadFileList() {
    try {
      loadingManager.show('#fileList', '正在同步索引...');
      const res = await apiManager.listLogFiles();
      if (res.success) {
        const container = document.getElementById('fileList');
        container.innerHTML = (res.data || []).map(f => `
                  <button class="btn btn-sm text-start file-item-btn ${f.name === currentFile ? 'active' : ''}" 
                          onclick="switchFile('${f.name}')">
                      <i class="bi bi-file-text me-2"></i>
                      ${f.name}
                      <span class="float-end opacity-50">${(f.size / 1024).toFixed(1)}KB</span>
                  </button>
              `).join('');
      } else {
        notificationManager.error(res.error || '获取文件列表失败');
      }
    } catch (e) {
      notificationManager.error('无法连接到日志服务');
    } finally {
      loadingManager.hide('#fileList');
    }
  }

  async function switchFile(name) {
    currentFile = name;
    document.getElementById('currentFileName').textContent = name;

    // 如果不是 app.log，暂停实时流
    if (name !== 'app.log' && !isStreamPaused) {
      togglePause();
      notificationManager.info('查看归档日志，已暂停实时流');
    }

    // 更新选中状态
    const btns = document.querySelectorAll('.file-item-btn');
    btns.forEach(btn => {
      if (btn.textContent.includes(name)) btn.classList.add('active');
      else btn.classList.remove('active');
    });

    await refreshLogs();
  }

  async function refreshLogs() {
    const viewer = document.getElementById('logViewer');

    try {
      loadingManager.show('#logViewer', '正在抓取日志流...');
      const res = await apiManager.getLogView(currentFile);
      if (res.success) {
        allLogs = (res.data.content || '').split('\n').filter(l => l.trim());
        renderLogLines();
        if (autoScroll) scrollToBottom();
      } else {
        notificationManager.error(res.error || '渲染日志失败');
        viewer.innerHTML = `<div class="alert alert-danger mx-3 mt-3">读取失败: ${res.error}</div>`;
      }
    } catch (e) {
      viewer.innerHTML = `<div class="alert alert-danger mx-3 mt-3">网络异常: ${e.message}</div>`;
      notificationManager.error('日志传输中断');
    } finally {
      loadingManager.hide('#logViewer');
    }
  }

  function renderLogLines() {
    const level = document.getElementById('logLevel').value;
    const search = document.getElementById('logSearch').value.toLowerCase();
    const viewer = document.getElementById('logViewer');

    const filtered = allLogs.filter(line => {
      const matchLevel = !level || line.includes(level);
      const matchSearch = !search || line.toLowerCase().includes(search);
      return matchLevel && matchSearch;
    });

    if (filtered.length === 0) {
      viewer.innerHTML = '<div class="text-center py-5 text-muted"><i class="bi bi-search d-block fs-1 mb-2 opacity-10"></i>未找到匹配的日志条目</div>';
      return;
    }

    viewer.innerHTML = `
            <div class="log-content-area">
                ${filtered.map(line => {
      let typeClass = 'info';
      if (line.includes('ERROR') || line.includes('CRITICAL')) typeClass = 'danger';
      else if (line.includes('WARNING')) typeClass = 'warning';
      else if (line.includes('DEBUG')) typeClass = 'secondary';

      return `<div class="log-line-new border-start border-3 border-${typeClass}">${safeHtml(line)}</div>`;
    }).join('')}
            </div>
        `;
    viewer.scrollTop = viewer.scrollHeight;
  }

  async function loadDbLogs() {
    const body = document.getElementById('dbLogsBody');

    try {
      // loadingManager.show('#dbLogsBody', '查询数据库...');
      const res = await apiManager.getErrorLogs(20);
      if (res.success) {
        body.innerHTML = res.data.items.map(l => `
                    <tr>
                        <td class="text-muted">#${l.id}</td>
                        <td class="text-muted small">${new Date(l.created_at + 'Z').toLocaleString()}</td>
                        <td><span class="badge-soft badge-soft-${l.level === 'ERROR' ? 'danger' : 'warning'}">${l.level}</span></td>
                        <td><code>${l.module}</code></td>
                        <td class="text-truncate" style="max-width: 400px;" title="${l.message}">${l.message}</td>
                    </tr>
                `).join('') || '<tr><td colspan="5" class="text-center py-4 text-muted">暂无异常记录</td></tr>';
      }
    } catch (e) {
      console.error('DB logs error', e);
    }
  }

  document.getElementById('logLevel').addEventListener('change', renderLogLines);
  document.getElementById('logSearch').addEventListener('input', renderLogLines);

  // 页面关闭清理
  window.addEventListener('beforeunload', () => {
    if (window.wsManager) {
      wsManager.unsubscribe('logs', handleLogMessage);
    }
  });
</script>

<style>
  .file-item-btn {
    border: 1px solid transparent;
    border-radius: 8px;
    transition: all 0.2s;
    padding: 0.6rem 1rem;
  }

  .file-item-btn:hover {
    background: rgba(var(--primary-rgb), 0.05);
    border-color: rgba(var(--primary-rgb), 0.1);
  }

  .file-item-btn.active {
    background: var(--primary-gradient);
    color: white;
    box-shadow: var(--shadow-sm);
  }

  .log-viewer-modern {
    background: rgba(0, 0, 0, 0.02);
    border-radius: 12px;
    height: 500px;
    overflow-y: auto;
    padding: 1rem;
    font-family: 'JetBrains Mono', 'Fira Code', monospace;
    font-size: 0.85rem;
  }

  .log-line-new {
    padding: 0.25rem 0.75rem;
    margin-bottom: 2px;
    white-space: pre-wrap;
    word-break: break-all;
  }

  .log-line-new:hover {
    background: rgba(0, 0, 0, 0.03);
  }

  .status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    margin-top: 10px;
    /* Align with select box */
    display: inline-block;
  }

  .status-dot.online {
    background-color: var(--success);
    box-shadow: 0 0 5px var(--success);
    animation: pulse 2s infinite;
  }

  .status-dot.offline {
    background-color: var(--secondary);
  }

  @keyframes pulse {
    0% {
      transform: scale(1);
      opacity: 1;
    }

    50% {
      transform: scale(1.2);
      opacity: 0.8;
    }

    100% {
      transform: scale(1);
      opacity: 1;
    }
  }
</style>
{% endblock %}