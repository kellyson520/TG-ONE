<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Forwarder Pro - 智能转发管理终端{% endblock %}</title>

    <!-- 核心依赖 (Local) -->
    <link href="/static/libs/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/static/libs/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
    <script src="/static/libs/echarts/echarts.min.js"></script>
    <link href="{{ static_with_hash('css/main.css') }}" rel="stylesheet">
    <style>
        /* Performance Optimization: Disable heavy filters and animations */
        .log-entry.animate-fade-in {
            animation: none !important;
            transition: none !important;
        }

        /* Optional: Toggle this if still laggy */
        /*
        .glass-card {
            backdrop-filter: none !important;
            -webkit-backdrop-filter: none !important;
            background: rgba(30, 30, 30, 0.95) !important;
        }
        */
    </style>
</head>

<body data-theme="dark">

    <div class="layout-wrapper visible" id="appLayout">
        <!-- Sidebar Navigation -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="brand-logo">
                    <div class="logo-box">
                        <i class="bi bi-send-fill text-white"></i>
                    </div>
                    <span>Forwarder <small>Pro</small></span>
                </div>
            </div>

            <div class="sidebar-menu mt-4">
                <div class="menu-category text-uppercase extra-small opacity-50 fw-bold px-4 mb-2">Workspace</div>
                <a class="menu-item {% if request.path == '/' %}active{% endif %}" href="/">
                    <i class="bi bi-speedometer2"></i><span>仪表盘控制中心</span>
                </a>

                <div class="menu-category text-uppercase extra-small opacity-50 fw-bold px-4 mt-4 mb-2">Configuration
                </div>
                <a class="menu-item {% if request.path == '/rules' %}active{% endif %}" href="/rules">
                    <i class="bi bi-stack"></i><span>转发规则引擎</span>
                </a>
                <a class="menu-item {% if request.path == '/visualization' %}active{% endif %}" href="/visualization">
                    <i class="bi bi-intersect"></i><span>链路拓扑可视化</span>
                </a>

                <div class="menu-category text-uppercase extra-small opacity-50 fw-bold px-4 mt-4 mb-2">Monitoring</div>
                <a class="menu-item {% if request.path == '/history' %}active{% endif %}" href="/history">
                    <i class="bi bi-clock-history"></i><span>全量转发历史</span>
                </a>
                <a class="menu-item {% if request.path == '/tasks' %}active{% endif %}" href="/tasks">
                    <i class="bi bi-lightning-charge"></i><span>异步任务队列</span>
                </a>
                <a class="menu-item {% if request.path == '/downloads' %}active{% endif %}" href="/downloads">
                    <i class="bi bi-cloud-download"></i><span>媒体资源下载</span>
                </a>
                <a class="menu-item {% if request.path == '/logs' %}active{% endif %}" href="/logs">
                    <i class="bi bi-window-sidebar"></i><span>系统运行日志</span>
                </a>
                <a class="menu-item {% if request.path == '/archive' %}active{% endif %}" href="/archive">
                    <i class="bi bi-archive"></i><span>数据冷库归档</span>
                </a>
                <a class="menu-item {% if request.path == '/audit_logs' %}active{% endif %}" href="/audit_logs">
                    <i class="bi bi-fingerprint"></i><span>行为审计轨迹</span>
                </a>

                <div class="menu-category text-uppercase extra-small opacity-50 fw-bold px-4 mt-4 mb-2">System</div>
                <a class="menu-item {% if request.path == '/users' %}active{% endif %}" href="/users">
                    <i class="bi bi-shield-shaded"></i><span>多租户管理</span>
                </a>
                <a class="menu-item {% if request.path == '/security' %}active{% endif %}" href="/security">
                    <i class="bi bi-safe"></i><span>安全中心 (2FA)</span>
                </a>
                <a class="menu-item {% if request.path == '/settings' %}active{% endif %}" href="/settings">
                    <i class="bi bi-gear-wide-connected"></i><span>底层核心配置</span>
                </a>
            </div>

            <div class="sidebar-footer">
                <div
                    class="user-pill d-flex align-items-center justify-content-between p-3 rounded-4 bg-white bg-opacity-5">
                    <div class="d-flex align-items-center gap-3">
                        <div class="avatar-sm rounded-3 bg-primary-gradient d-flex align-items-center justify-content-center text-white"
                            style="width: 32px; height: 32px;">
                            <i class="bi bi-person-fill"></i>
                        </div>
                        <div class="lh-1">
                            <div class="fw-bold extra-small text-white">Root Admin</div>
                            <div class="text-success extra-small opacity-75" style="font-size: 10px;"><i
                                    class="bi bi-circle-fill me-1" style="font-size: 6px;"></i> Active</div>
                        </div>
                    </div>
                    <button class="btn btn-link link-light p-0 opacity-50" onclick="handleLogout()" title="安全登出">
                        <i class="bi bi-power"></i>
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content Core -->
        <main class="main-content" id="mainContent">
            <nav class="top-navbar px-4">
                <div class="d-flex align-items-center gap-3">
                    <button class="btn btn-link link-light p-0 d-lg-none" onclick="toggleSidebar()">
                        <i class="bi bi-list fs-3"></i>
                    </button>
                    <div class="navbar-breadcrumb d-none d-md-block">
                        <span class="text-muted extra-small">SYSTEM /</span>
                        <span class="fw-bold small ms-1 text-white opacity-75">{% block page_title %}CONTROLPANEL{%
                            endblock %}</span>
                    </div>
                </div>

                <div class="d-flex align-items-center gap-4">
                    <div class="d-none d-lg-flex align-items-center gap-3">
                        <div class="status-indicator d-flex align-items-center gap-2">
                            <i class="bi bi-cpu text-primary-gradient small"></i>
                            <span class="extra-small font-monospace" id="nav-cpu">--</span>
                        </div>
                        <div class="status-indicator d-flex align-items-center gap-2">
                            <i class="bi bi-memory text-info-gradient small"></i>
                            <span class="extra-small font-monospace" id="nav-mem">--</span>
                        </div>
                    </div>
                    <div class="v-line h-50 bg-white opacity-10 mx-1 d-none d-lg-block" style="width:1px"></div>
                    <button class="btn btn-sm btn-dark border-0 rounded-circle" onclick="toggleTheme()"
                        id="themeToggle">
                        <i class="bi bi-moon-stars" id="themeIcon"></i>
                    </button>
                </div>
            </nav>

            <div class="content-padding px-4 py-4">
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>

    <!-- Notification Container -->
    <div id="notification-root" class="position-fixed top-0 end-0 p-4" style="z-index: 9999; pointer-events: none;">
    </div>

    <!-- Scripts Core -->
    <script src="/static/libs/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="{{ static_with_hash('js/main.js') }}"></script>
    <script>
        // Notification Handler
        function showNotification(msg, type = 'info') {
            const root = document.getElementById('notification-root');
            const toast = document.createElement('div');
            toast.className = `glass-card p-3 mb-2 animate-slide-in pointer-events-auto border-start border-4 border-${type === 'info' ? 'primary' : type}`;
            toast.style.width = '300px';
            toast.style.pointerEvents = 'auto';
            toast.innerHTML = `<div class="d-flex align-items-center gap-3 small"><i class="bi bi-app-indicator text-${type}"></i><div class="fw-bold">${msg}</div></div>`;
            root.appendChild(toast);
            setTimeout(() => {
                toast.classList.replace('animate-slide-in', 'animate-fade-out');
                setTimeout(() => toast.remove(), 500);
            }, 4000);
        }

        // Theme Control
        function toggleTheme() {
            const current = document.body.getAttribute('data-theme');
            const target = current === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', target);
            localStorage.setItem('theme', target);
            document.getElementById('themeIcon').className = target === 'dark' ? 'bi bi-moon-stars' : 'bi bi-sun';
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        async function updateSystemMetrics() {
            try {
                const res = await apiManager.get('/system/resources'); // Ensure endpoint exists or fallback to direct fetch
                if (res.success) {
                    document.getElementById('nav-cpu').innerText = `${Math.round(res.data.cpu)}%`;
                    document.getElementById('nav-mem').innerText = `${Math.round(res.data.memory)}%`;
                }
            } catch (e) { console.debug('Metrics update skipped'); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', savedTheme);
            document.getElementById('themeIcon').className = savedTheme === 'dark' ? 'bi bi-moon-stars' : 'bi bi-sun';

            updateSystemMetrics();
            setInterval(updateSystemMetrics, 10000);
        });

        async function handleLogout() {
            if (confirm('确认注销并结束当前会话？')) {
                const res = await apiManager.post('/auth/logout', {});
                if (res.success) location.href = '/login';
            }
        }
    </script>
</body>

</html>