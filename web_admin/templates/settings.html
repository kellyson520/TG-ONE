{% extends "base.html" %}
{% block title %}系统设置 - Forwarder Pro{% endblock %}
{% block content %}

<div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
        <h4 class="mb-0 fw-bold">系统设置</h4>
        <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-secondary" id="refreshBtn">
                <i class="bi bi-arrow-clockwise me-1"></i> 刷新
            </button>
            <button class="btn btn-sm btn-primary-gradient px-3" id="saveBtn">
                <i class="bi bi-save me-1"></i> 保存更改
            </button>
        </div>
    </div>
</div>

<div id="settingsContainer" class="row g-4">
    <div class="col-12 text-center py-5 text-muted">正在加载配置项...</div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let meta = []
    let values = {}

    document.addEventListener('DOMContentLoaded', function () {
        loadMetaAndValues()
        document.getElementById('refreshBtn').addEventListener('click', loadMetaAndValues)
        document.getElementById('saveBtn').addEventListener('click', saveSettings)
    })

    async function loadMetaAndValues() {
        try {
            const [m, v] = await Promise.all([
                apiManager.getSettingsMeta(),
                apiManager.getSettings()
            ])
            if (m.success && v.success) {
                meta = m.data
                values = v.data
                renderSettings()
            }
        } catch (e) {
            console.error('加载设置失败:', e)
        }
    }

    function renderSettings() {
        const container = document.getElementById('settingsContainer')
        container.innerHTML = ''
        const groups = {}
        meta.forEach(item => {
            groups[item.group] = groups[item.group] || []
            groups[item.group].push(item)
        })

        Object.keys(groups).forEach(group => {
            const col = document.createElement('div')
            col.className = 'col-12 col-xl-6'

            const groupHtml = `
                <div class="glass-card h-100 p-4">
                    <h5 class="fw-bold mb-4 border-bottom pb-3">${group}</h5>
                    <div class="row g-3">
                        ${groups[group].map(item => {
                const id = `setting_${item.key}`
                let current = values[item.key]
                if (item.type === 'boolean') {
                    const s = String(current || '').toLowerCase()
                    current = s === 'true' || s === '1' || s === 'yes' || s === 'on'
                }

                let control = ''
                if (item.sensitive) {
                    const configured = !!item.value_present
                    const ph = configured ? '已配置，输入新值以更新' : '未配置，请输入值'
                    control = `<input type="password" class="form-control form-control-sm" id="${id}" placeholder="${ph}">`
                } else if (item.type === 'boolean') {
                    control = `
                                    <div class="form-check form-switch mt-1">
                                        <input class="form-check-input" type="checkbox" id="${id}" ${current ? 'checked' : ''}>
                                    </div>`
                } else if (item.type === 'integer') {
                    control = `<input type="number" class="form-control form-control-sm" id="${id}" value="${Number(current ?? 0)}" min="${item.min ?? 0}" max="${item.max ?? 1000000}">`
                } else if (item.options) {
                    control = `<select class="form-select form-select-sm" id="${id}">${item.options.map(opt => `<option value="${opt}" ${String(current) === String(opt) ? 'selected' : ''}>${opt}</option>`).join('')}</select>`
                } else {
                    control = `<input type="text" class="form-control form-control-sm" id="${id}" value="${current ?? ''}">`
                }

                const badge = item.requires_restart ? '<span class="badge-soft badge-soft-warning ms-2" style="font-size: 0.65rem;">需重启</span>' : ''

                return `
                                <div class="col-12">
                                    <div class="row align-items-center">
                                        <div class="col-md-5">
                                            <label class="form-label mb-md-0 small fw-medium text-muted">${item.label || item.key}${badge}</label>
                                        </div>
                                        <div class="col-md-7">
                                            ${control}
                                        </div>
                                    </div>
                                </div>
                            `
            }).join('')}
                    </div>
                </div>
            `
            col.innerHTML = groupHtml
            container.appendChild(col)
        })
    }

    async function saveSettings() {
        const payload = {}
        meta.forEach(item => {
            const id = `setting_${item.key}`
            const el = document.getElementById(id)
            if (!el) return
            if (item.sensitive && !el.value) return

            if (item.type === 'boolean') {
                payload[item.key] = el.checked
            } else if (item.type === 'integer') {
                payload[item.key] = parseInt(el.value || '0')
            } else {
                payload[item.key] = el.value
            }
        })

        try {
            const res = await apiManager.updateSettings(payload)
            if (res.success) {
                if (window.toastManager) window.toastManager.show('设置已保存', 'success')
                else alert('设置已保存')
                loadMetaAndValues()
            }
        } catch (e) {
            console.error('保存设置失败:', e)
        }
    }
</script>
{% endblock %}