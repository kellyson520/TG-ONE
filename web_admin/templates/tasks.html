{% extends "base.html" %}
{% block title %}任务队列 - Forwarder Pro{% endblock %}
{% block content %}

<div class="row mb-4">
    <div class="col-12">
        <h4 class="fw-bold mb-0">系统任务队列</h4>
        <p class="text-muted small">实时查看并监控后台异步处理任务的状态</p>
    </div>
</div>

<div class="glass-card p-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
        <h6 class="fw-bold mb-0"><i class="bi bi-stack me-2"></i>队列列表</h6>
        <div class="d-flex gap-2">
            <select class="form-select form-select-sm border-0 bg-white bg-opacity-10" id="statusFilter"
                style="width: 140px;" onchange="loadTasks(1)">
                <option value="">全部状态</option>
                <option value="pending">待处理</option>
                <option value="running">运行中</option>
                <option value="completed">已完成</option>
                <option value="failed">已失败</option>
            </select>
            <button class="btn btn-sm btn-primary-gradient px-3" onclick="loadTasks(1)">
                <i class="bi bi-arrow-clockwise"></i>
            </button>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover table-sm small align-middle">
            <thead>
                <tr class="text-muted opacity-75">
                    <th width="60">ID</th>
                    <th width="120">任务类型</th>
                    <th width="100">当前状态</th>
                    <th>目标标识 (Key / Group)</th>
                    <th width="60">权重</th>
                    <th width="60">重试</th>
                    <th width="200">时间追踪</th>
                    <th width="60" class="text-end">管理</th>
                </tr>
            </thead>
            <tbody id="tasksTableBody" class="border-top-0">
                <tr>
                    <td colspan="8" class="text-center py-5">
                        <div class="spinner-border spinner-border-sm text-primary"></div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-4">
        <div class="extra-small text-muted" id="pageInfo"></div>
        <nav>
            <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
        </nav>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let currentPage = 1;
    let tasksCache = new Map(); // 缓存任务数据用于实时更新
    let wsConnected = false;

    document.addEventListener('DOMContentLoaded', () => {
        loadTasks(1);
        initWebSocket();
    });

    // ========== WebSocket 实时更新 ==========

    function initWebSocket() {
        if (!window.wsManager) {
            console.warn('[Tasks] WebSocket not available, using polling fallback');
            return;
        }

        // 连接 WebSocket
        wsManager.connect();

        // 监听连接状态
        wsManager.onConnect(() => {
            wsConnected = true;
            console.log('[Tasks] WebSocket connected, subscribing to system events');

            // 订阅系统事件 (任务更新会通过 system 主题广播)
            wsManager.subscribe('system', handleTaskUpdate);

            // 显示连接状态
            showConnectionStatus(true);
        });

        wsManager.onDisconnect(() => {
            wsConnected = false;
            showConnectionStatus(false);
        });
    }

    function handleTaskUpdate(message) {
        // 处理任务状态更新消息
        if (message.event && message.event.startsWith('TASK_')) {
            const taskData = message.data;

            if (message.event === 'TASK_UPDATED' || message.event === 'TASK_STATUS_CHANGED') {
                updateTaskInTable(taskData);
            } else if (message.event === 'TASK_CREATED') {
                // 新任务创建，刷新列表
                loadTasks(currentPage);
            } else if (message.event === 'TASK_COMPLETED' || message.event === 'TASK_FAILED') {
                updateTaskInTable(taskData);
                // 显示通知
                const status = message.event === 'TASK_COMPLETED' ? 'success' : 'error';
                notificationManager[status](`任务 #${taskData.id} 已${message.event === 'TASK_COMPLETED' ? '完成' : '失败'}`);
            }
        }
    }

    function updateTaskInTable(taskData) {
        const taskId = taskData.id;
        tasksCache.set(taskId, taskData);

        // 查找对应的表格行
        const row = document.querySelector(`tr[data-task-id="${taskId}"]`);
        if (!row) return;

        // 更新状态徽章
        const statusBadge = row.querySelector('.task-status-badge');
        if (statusBadge) {
            const oldStatus = statusBadge.dataset.status;
            const newStatus = taskData.status;

            if (oldStatus !== newStatus) {
                // 添加动画效果
                statusBadge.classList.add('animate-pulse');
                setTimeout(() => statusBadge.classList.remove('animate-pulse'), 500);

                statusBadge.className = `badge-soft badge-soft-${getStatusCls(newStatus)} task-status-badge`;
                statusBadge.dataset.status = newStatus;
                statusBadge.textContent = newStatus.toUpperCase();
            }
        }

        // 更新进度条 (如果有)
        const progressBar = row.querySelector('.task-progress-bar');
        if (progressBar && taskData.progress !== undefined) {
            updateProgressBar(progressBar, taskData.progress);
        }

        // 更新重试次数
        const retryCell = row.querySelector('.task-retry-count');
        if (retryCell && taskData.retry_count !== undefined) {
            retryCell.innerHTML = taskData.retry_count > 0
                ? `<span class="badge-soft badge-soft-warning">${taskData.retry_count}</span>`
                : '0';
        }

        // 更新时间
        const timeCell = row.querySelector('.task-time');
        if (timeCell && taskData.updated_at) {
            timeCell.innerHTML = `
                <div>入队: ${new Date(taskData.created_at).toLocaleString()}</div>
                <div class="opacity-75">最后同步: ${new Date(taskData.updated_at).toLocaleString()}</div>
            `;
        }
    }

    function updateProgressBar(progressBar, progress) {
        const percentage = Math.min(100, Math.max(0, progress));
        progressBar.style.width = `${percentage}%`;
        progressBar.setAttribute('aria-valuenow', percentage);
        progressBar.textContent = `${percentage}%`;

        // 根据进度改变颜色
        if (percentage >= 100) {
            progressBar.className = 'progress-bar bg-success';
        } else if (percentage >= 50) {
            progressBar.className = 'progress-bar bg-info';
        } else {
            progressBar.className = 'progress-bar bg-primary';
        }
    }

    function showConnectionStatus(connected) {
        const indicator = document.getElementById('wsStatusIndicator');
        if (!indicator) {
            // 创建状态指示器
            const statusDiv = document.createElement('div');
            statusDiv.id = 'wsStatusIndicator';
            statusDiv.className = `position-fixed bottom-0 end-0 m-3 badge badge-soft-${connected ? 'success' : 'secondary'} extra-small`;
            statusDiv.innerHTML = `<i class="bi bi-broadcast me-1"></i> ${connected ? '实时连接' : '离线模式'}`;
            document.body.appendChild(statusDiv);
        } else {
            indicator.className = `position-fixed bottom-0 end-0 m-3 badge badge-soft-${connected ? 'success' : 'secondary'} extra-small`;
            indicator.innerHTML = `<i class="bi bi-broadcast me-1"></i> ${connected ? '实时连接' : '离线模式'}`;
        }
    }

    // ========== API 加载 (初始化 + 降级方案) ==========

    async function loadTasks(page = 1) {
        currentPage = page;
        const status = document.getElementById('statusFilter').value;
        const tbody = document.getElementById('tasksTableBody');

        try {
            loadingManager.show('#tasksTableBody', '正在同步队列状态...');
            const res = await apiManager.getTasks({ page, limit: 15, status });

            if (res.success) {
                // 更新缓存
                res.data.items.forEach(task => tasksCache.set(task.id, task));

                renderTable(res.data.items);
                renderPagination(res.data);
                document.getElementById('pageInfo').innerText = `显示 ${res.data.total} 个任务中第 ${page} 页`;
            } else {
                notificationManager.error(res.error || '检索队列失败');
                tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">数据同步中断: ${res.error}</td></tr>`;
            }
        } catch (e) {
            notificationManager.error('无法连接到任务分发服务');
            tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">心跳连接异常: ${e.message}</td></tr>`;
        } finally {
            loadingManager.hide('#tasksTableBody');
        }
    }

    function renderTable(items) {
        const tbody = document.getElementById('tasksTableBody');
        if (!items || items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" class="text-center py-5 text-muted"><i class="bi bi-inbox d-block fs-1 mb-2 opacity-10"></i>当前队列无挂载任务</td></tr>';
            return;
        }

        tbody.innerHTML = items.map(item => `
            <tr data-task-id="${item.id}">
                <td class="text-muted">#${item.id}</td>
                <td><span class="badge-soft badge-soft-primary font-monospace extra-small">${item.type}</span></td>
                <td>
                    <span class="badge-soft badge-soft-${getStatusCls(item.status)} task-status-badge" data-status="${item.status}">
                        ${item.status.toUpperCase()}
                    </span>
                    ${item.status === 'running' && item.progress !== undefined ? `
                        <div class="progress mt-1" style="height: 4px; width: 100px;">
                            <div class="progress-bar task-progress-bar" role="progressbar" 
                                 style="width: ${item.progress || 0}%" 
                                 aria-valuenow="${item.progress || 0}" 
                                 aria-valuemin="0" 
                                 aria-valuemax="100"></div>
                        </div>
                    ` : ''}
                </td>
                <td>
                    <div class="extra-small text-truncate" style="max-width: 250px;" title="${item.unique_key || '-'}">
                        <span class="opacity-50 me-1">路由键:</span>${item.unique_key || '-'}
                    </div>
                </td>
                <td><span class="opacity-75">${item.priority}</span></td>
                <td class="task-retry-count">${item.retry_count > 0 ? `<span class="badge-soft badge-soft-warning">${item.retry_count}</span>` : '0'}</td>
                <td class="extra-small text-muted task-time">
                    <div>入队: ${new Date(item.created_at).toLocaleString()}</div>
                    <div class="opacity-75">最后同步: ${new Date(item.updated_at).toLocaleString()}</div>
                </td>
                <td class="text-end">
                    <button class="btn btn-dark btn-sm border-0 btn-hover-info" onclick="viewDetails('${item.id}', \`${(item.error_log || '').replace(/`/g, '\\`')}\`)">
                        <i class="bi bi-info-circle"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function getStatusCls(status) {
        return {
            'pending': 'warning',
            'running': 'primary',
            'completed': 'success',
            'failed': 'danger'
        }[status] || 'secondary';
    }

    function renderPagination(data) {
        const ul = document.getElementById('pagination');
        ul.innerHTML = `
            <li class="page-item ${data.page <= 1 ? 'disabled' : ''}">
                <a class="page-link shadow-none" href="javascript:loadTasks(${data.page - 1})"><i class="bi bi-chevron-left"></i></a>
            </li>
            <li class="page-item active"><span class="page-link shadow-none">${data.page} / ${data.total_pages || 1}</span></li>
            <li class="page-item ${data.page >= data.total_pages ? 'disabled' : ''}">
                <a class="page-link shadow-none" href="javascript:loadTasks(${data.page + 1})"><i class="bi bi-chevron-right"></i></a>
            </li>
        `;
    }

    function viewDetails(id, log) {
        if (!log || log === 'null' || log === '') {
            notificationManager.info(`任务 #${id} 运作正常，无错误记录`);
        } else {
            // 使用更专业的日志查看方式
            const logContent = log.length > 1000 ? log.substring(0, 1000) + '...' : log;
            notificationManager.error(`任务 #${id} 异常摘要: ${logContent.substring(0, 100)}`);
            console.error(`Task #${id} Error Log:`, log);
        }
    }

    // 页面卸载时断开 WebSocket
    window.addEventListener('beforeunload', () => {
        if (wsConnected && window.wsManager) {
            wsManager.unsubscribe('system', handleTaskUpdate);
        }
    });
</script>
{% endblock %}
{% endblock %}