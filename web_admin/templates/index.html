{% extends "base.html" %}
{% block title %}仪表盘 - Forwarder Pro{% endblock %}
{% block content %}

<!-- Header -->
<div class="row mb-4">
    <div class="col-12">
        <h4 class="fw-bold mb-0">系统概览</h4>
        <p class="text-muted small">实时监控消息转发状态与系统运行指标</p>
    </div>
</div>

<!-- Metrics Row -->
<div class="row g-4 mb-4">
    <div class="col-md-3">
        <div class="glass-card p-4">
            <div class="d-flex align-items-center justify-content-between mb-2">
                <div
                    class="avatar-sm bg-primary-gradient rounded-4 d-flex align-items-center justify-content-center text-white">
                    <i class="bi bi-send fs-5"></i>
                </div>
                <span class="badge-success-soft extra-small">+12%</span>
            </div>
            <div class="text-muted extra-small fw-bold text-uppercase opacity-75">今日转发总计</div>
            <div class="fs-3 fw-bold mt-1" id="todayForwards">0</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="glass-card p-4">
            <div class="d-flex align-items-center justify-content-between mb-2">
                <div
                    class="avatar-sm bg-info-gradient rounded-4 d-flex align-items-center justify-content-center text-white">
                    <i class="bi bi-diagram-2 fs-5"></i>
                </div>
                <span class="badge-primary-soft extra-small">稳定</span>
            </div>
            <div class="text-muted extra-small fw-bold text-uppercase opacity-75">当前活跃规则</div>
            <div class="fs-3 fw-bold mt-1" id="activeRules">0</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="glass-card p-4">
            <div class="d-flex align-items-center justify-content-between mb-2">
                <div
                    class="avatar-sm bg-warning-gradient rounded-4 d-flex align-items-center justify-content-center text-white">
                    <i class="bi bi-filter fs-5"></i>
                </div>
                <span class="badge-warning-soft extra-small">去重中</span>
            </div>
            <div class="text-muted extra-small fw-bold text-uppercase opacity-75">去重指纹缓存</div>
            <div class="fs-3 fw-bold mt-1" id="dedupCache">0</div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="glass-card p-4 text-white" style="background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);">
            <div class="d-flex align-items-center justify-content-between mb-2">
                <div
                    class="avatar-sm bg-white bg-opacity-20 rounded-4 d-flex align-items-center justify-content-center">
                    <i class="bi bi-activity fs-5"></i>
                </div>
                <i class="bi bi-exclamation-triangle-fill opacity-50"></i>
            </div>
            <div class="extra-small fw-bold text-uppercase opacity-75">异常转发率</div>
            <div class="fs-3 fw-bold mt-1" id="errorRate">0.00%</div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row g-4">
    <div class="col-lg-8">
        <div class="glass-card p-4">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h6 class="fw-bold mb-0">七日转发趋势</h6>
                <div class="btn-group btn-group-sm">
                    <button class="btn btn-dark active">量级</button>
                    <button class="btn btn-dark">成功率</button>
                </div>
            </div>
            <div id="trafficChart" style="height: 340px; width: 100%;"></div>
        </div>
    </div>
    <div class="col-lg-4">
        <div class="glass-card p-4">
            <h6 class="fw-bold mb-4">消息类型组成</h6>
            <div id="pieChart" style="height: 340px; width: 100%;"></div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    let trafficChart, pieChart;
    let refreshInterval;

    document.addEventListener('DOMContentLoaded', () => {
        initCharts();
        loadDashboardData();
        refreshInterval = setInterval(loadDashboardData, 30000);

        document.addEventListener('visibilitychange', () => {
            if (document.hidden) clearInterval(refreshInterval);
            else refreshInterval = setInterval(loadDashboardData, 30000);
        });
    });

    function initCharts() {
        const isDark = document.body.getAttribute('data-theme') === 'dark';
        const textColor = isDark ? 'rgba(255,255,255,0.6)' : 'rgba(0,0,0,0.4)';

        trafficChart = echarts.init(document.getElementById('trafficChart'));
        pieChart = echarts.init(document.getElementById('pieChart'));

        const trafficOpt = {
            tooltip: { trigger: 'axis', backgroundColor: '#1a1a1a', borderColor: '#333', textStyle: { color: '#eee' } },
            grid: { top: 20, left: 10, right: 10, bottom: 0, containLabel: true },
            xAxis: { type: 'category', data: [], axisLine: { show: false }, axisTick: { show: false }, axisLabel: { color: textColor } },
            yAxis: { type: 'value', splitLine: { lineStyle: { type: 'dashed', color: isDark ? '#333' : '#eee' } }, axisLabel: { color: textColor } },
            series: [{
                type: 'line', smooth: true, showSymbol: false,
                lineStyle: { width: 4, color: '#6366f1' },
                areaStyle: {
                    color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [
                        { offset: 0, color: 'rgba(99, 102, 241, 0.2)' },
                        { offset: 1, color: 'transparent' }
                    ])
                },
                data: []
            }]
        };

        const pieOpt = {
            tooltip: { trigger: 'item', backgroundColor: '#1a1a1a', textStyle: { color: '#eee' } },
            series: [{
                type: 'pie', radius: ['60%', '85%'], avoidLabelOverlap: false,
                itemStyle: { borderRadius: 12, borderColor: isDark ? '#1a1a1a' : '#fff', borderWidth: 2 },
                label: { show: false },
                data: []
            }]
        };

        trafficChart.setOption(trafficOpt);
        pieChart.setOption(pieOpt);

        window.addEventListener('resize', () => {
            trafficChart.resize();
            pieChart.resize();
        });
    }

    async function loadDashboardData() {
        try {
            const [stats, series, dist] = await Promise.all([
                apiManager.getStatsOverview(),
                apiManager.getStatsSeries({ days: 7 }),
                apiManager.request('/stats/distribution')
            ]);

            if (stats.success) {
                const ov = stats.data.overview || {};
                const fw = stats.data.forward_stats || {};
                const de = stats.data.dedup_stats || {};

                document.getElementById('todayForwards').innerText = (fw.total_forwards || 0).toLocaleString();
                document.getElementById('activeRules').innerText = (ov.active_rules || 0).toLocaleString();
                document.getElementById('dedupCache').innerText = (de.cached_signatures || 0).toLocaleString();

                const rate = fw.total_forwards > 0 ? ((fw.error_count / fw.total_forwards) * 100).toFixed(2) : '0.00';
                document.getElementById('errorRate').innerText = rate + '%';
            }

            if (series.success && series.data) {
                trafficChart.setOption({
                    xAxis: { data: series.data.labels },
                    series: [{ data: series.data.series }]
                });
            }

            if (dist.success && dist.data) {
                pieChart.setOption({ series: [{ data: dist.data }] });
            }
        } catch (e) {
            console.warn('Dashboard sync delayed:', e);
        }
    }
</script>
{% endblock %}