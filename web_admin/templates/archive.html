{% extends "base.html" %}
{% block title %}数据归档 - Forwarder Pro{% endblock %}
{% block content %}

<div class="row mb-4">
    <div class="col-12">
        <h4 class="fw-bold mb-0">冷数据归档管理</h4>
        <p class="text-muted small">自动将历史日志迁移至 Parquet 格式，保持系统轻盈高效</p>
    </div>
</div>

<div class="row g-4 mb-4">
    <!-- 归档状态概览 -->
    <div class="col-lg-8">
        <div class="glass-card p-4 h-100">
            <div class="d-flex align-items-center justify-content-between mb-4">
                <h6 class="mb-0 fw-bold">
                    <i class="bi bi-archive text-primary me-2"></i>热数据存量 (SQLite)
                </h6>
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-outline-light rounded-pill px-3" onclick="loadArchiveStatus()">
                        <i class="bi bi-arrow-clockwise"></i>
                    </button>
                    <button class="btn btn-sm btn-primary-gradient px-3" onclick="triggerArchive()" id="triggerBtn">
                        立即执行归档
                    </button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="table table-hover table-sm small align-middle">
                    <thead>
                        <tr class="text-muted opacity-75">
                            <th>数据对象</th>
                            <th>记录数</th>
                            <th>保留周期</th>
                            <th class="text-end">管理</th>
                        </tr>
                    </thead>
                    <tbody id="archiveTableBody" class="border-top-0">
                        <!-- Content -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- 引擎状态 -->
    <div class="col-lg-4">
        <div class="glass-card p-4 h-100">
            <h6 class="fw-bold mb-4">
                <i class="bi bi-cpu-fill text-info me-2"></i>引擎状态
            </h6>

            <div class="p-3 bg-white bg-opacity-10 rounded-4 mb-4">
                <div class="extra-small text-muted mb-1 text-uppercase fw-bold">Current Thread</div>
                <div class="d-flex align-items-center gap-3">
                    <div id="engineStatusDot"
                        class="avatar-sm rounded-circle d-flex align-items-center justify-content-center bg-secondary"
                        style="width: 12px; height: 12px;"></div>
                    <div class="fw-bold small" id="engineStatusText">正在侦测服务...</div>
                </div>
            </div>

            <div class="alert badge-info-soft border-0 rounded-4 extra-small mb-4">
                <i class="bi bi-info-circle me-1"></i> 归档逻辑按天级别滚动，将 SQLite 记录持久化至 <code>/archives</code> 目录。
            </div>

            <div class="pt-2">
                <h6 class="extra-small fw-bold text-muted text-uppercase mb-3">配置策略预览</h6>
                <div id="configList" class="d-flex flex-wrap gap-2">
                    <!-- Dynamic Badges -->
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="glass-card p-4 text-center">
            <div class="avatar-sm bg-success-gradient rounded-circle d-flex align-items-center justify-content-center text-white mx-auto mb-3"
                style="width: 48px; height: 48px;">
                <i class="bi bi-database-check fs-4"></i>
            </div>
            <h6 class="fw-bold mb-2">Parquet 冷存储就绪</h6>
            <p class="text-muted extra-small mb-0">
                归档数据已分区存储，您可以使用分析工具通过 SQL (DuckDB) 直接读取 <code>ARCHIVE_ROOT</code> 下的文件。
            </p>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => loadArchiveStatus());

    async function loadArchiveStatus() {
        try {
            loadingManager.show('#archiveTableBody', '正在同步数据库存量...');
            const res = await apiManager.getArchiveStatus();
            if (res.success) {
                renderStatus(res.data);
            } else {
                notificationManager.error(res.error || '存量统计失败');
            }
        } catch (e) {
            notificationManager.error('统计服务连接异常');
        } finally {
            loadingManager.hide('#archiveTableBody');
        }
    }

    function renderStatus(data) {
        const tbody = document.getElementById('archiveTableBody');
        const tableNames = {
            "rule_logs": "转发日志 (RuleLog)",
            "rule_statistics": "规则统计 (RuleStats)",
            "chat_statistics": "聊天统计 (ChatStats)",
            "error_logs": "系统错误 (ErrorLog)",
            "media_signatures": "媒体指纹 (MediaSign)",
            "task_queue": "任务队列 (TaskQueue)"
        };

        if (!data || !data.sqlite_counts) {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted">目前无待处理数据表</td></tr>';
            return;
        }

        tbody.innerHTML = Object.entries(data.sqlite_counts).map(([key, count]) => `
            <tr>
                <td>
                    <div class="fw-bold text-dark">${tableNames[key] || key}</div>
                    <div class="extra-small text-muted font-monospace opacity-75">${key}</div>
                </td>
                <td><span class="badge-soft badge-soft-primary">${count.toLocaleString()}</span></td>
                <td><span class="badge-soft badge-soft-info">${data.archive_config[key] || '-'} 天</span></td>
                <td class="text-end">
                    <button class="btn btn-dark btn-sm border-0 btn-hover-primary opa-50" disabled><i class="bi bi-search"></i></button>
                </td>
            </tr>
        `).join('');

        const dot = document.getElementById('engineStatusDot');
        const text = document.getElementById('engineStatusText');
        if (data.is_running) {
            dot.className = 'avatar-sm rounded-circle d-flex bg-success shadow-success';
            text.innerText = '正在执行后台归档...';
            document.getElementById('triggerBtn').disabled = true;
        } else {
            dot.className = 'avatar-sm rounded-circle d-flex bg-info shadow-info';
            text.innerText = '节点就绪 (空闲中)';
            document.getElementById('triggerBtn').disabled = false;
        }

        const configList = document.getElementById('configList');
        configList.innerHTML = Object.entries(data.archive_config).map(([key, days]) => `
            <div class="badge-soft badge-soft-secondary extra-small px-2 py-1">${key}: ${days}d</div>
        `).join('');
    }

    async function triggerArchive() {
        if (!confirm('启动归档将进行大规模 IO 操作并可能在短时间内占据大量 CPU 资源，确定现在执行吗？')) return;
        const btn = document.getElementById('triggerBtn');
        try {
            loadingManager.show(btn, '正在派发...');
            const res = await apiManager.triggerArchive();
            if (res.success) {
                notificationManager.success(res.message || '归档任务已分配至后台 worker');
                loadArchiveStatus();
            } else {
                notificationManager.error(res.error || '任务启动失败');
            }
        } catch (e) {
            notificationManager.error('引擎网关响应异常');
        } finally {
            loadingManager.hide(btn);
        }
    }
</script>
{% endblock %}

{% endblock %}