{% extends "base.html" %}
{% block title %}审计日志 - Forwarder Pro{% endblock %}
{% block content %}

<div class="row mb-4">
    <div class="col-12">
        <h4 class="fw-bold mb-0">安全审计</h4>
        <p class="text-muted small">所有管理操作的合规性追溯记录</p>
    </div>
</div>

<div class="glass-card p-4">
    <div class="d-flex flex-wrap justify-content-between align-items-center gap-3 mb-4">
        <h6 class="fw-bold mb-0"><i class="bi bi-shield-check me-2"></i>操作流水</h6>
        <div class="d-flex gap-2">
            <div class="input-group input-group-sm" style="width: 240px;">
                <span class="input-group-text bg-transparent border-end-0"><i class="bi bi-funnel"></i></span>
                <input type="text" class="form-control border-start-0" id="auditAction" placeholder="筛选操作 (如: LOGIN)">
            </div>
            <button class="btn btn-sm btn-primary-gradient px-3" onclick="loadAuditLogs(1)">查询</button>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover table-sm small align-middle">
            <thead>
                <tr class="text-muted">
                    <th width="60">ID</th>
                    <th width="160">时间</th>
                    <th width="100">用户</th>
                    <th width="120">操作</th>
                    <th width="140">IP / 来源</th>
                    <th width="80">状态</th>
                    <th>操作详情</th>
                </tr>
            </thead>
            <tbody id="auditBody">
                <tr>
                    <td colspan="7" class="text-center py-5">
                        <div class="spinner-border spinner-border-sm text-primary"></div>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>

    <div class="d-flex justify-content-between align-items-center mt-4">
        <div class="extra-small text-muted" id="pageInfo"></div>
        <nav>
            <ul class="pagination pagination-sm mb-0" id="auditPagination"></ul>
        </nav>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    async function loadAuditLogs(page = 1) {
        const action = document.getElementById('auditAction').value;
        const tbody = document.getElementById('auditBody');

        try {
            loadingManager.show('#auditBody', '正在提取审计记录...');
            const res = await apiManager.getAuditLogs({ page, size: 15, action });

            if (res.success) {
                const logs = res.data.logs || [];
                tbody.innerHTML = logs.map(l => `
                    <tr>
                        <td class="text-muted">#${l.id}</td>
                        <td class="text-muted">${new Date(l.timestamp + 'Z').toLocaleString()}</td>
                        <td><span class="fw-bold text-dark">${l.username || 'System'}</span></td>
                        <td><span class="badge-soft badge-soft-primary">${l.action}</span></td>
                        <td class="font-monospace opacity-75 small">${l.ip_address || '-'}</td>
                        <td><span class="badge-soft badge-soft-${l.status === 'success' ? 'success' : 'danger'}">${l.status === 'success' ? '通过' : '拒绝'}</span></td>
                        <td class="text-muted extra-small text-break">${l.details || '-'}</td>
                    </tr>
                `).join('') || '<tr><td colspan="7" class="text-center py-4 text-muted">检索到零条符合条件的记录</td></tr>';

                renderPager(page, res.data.total_pages);
                document.getElementById('pageInfo').innerText = `共 ${res.data.total} 条合规流水 / 第 ${page} 页`;
            } else {
                notificationManager.error(res.error || '检索解析失败');
                tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">数据检索中途中断</td></tr>`;
            }
        } catch (e) {
            notificationManager.error('审计网关连接异常');
            tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">安全服务连接失败: ${e.message}</td></tr>`;
        } finally {
            loadingManager.hide('#auditBody');
        }
    }

    function renderPager(current, total) {
        const ul = document.getElementById('auditPagination');
        ul.innerHTML = `
            <li class="page-item ${current <= 1 ? 'disabled' : ''}">
                <a class="page-link shadow-none" href="javascript:loadAuditLogs(${current - 1})"><i class="bi bi-chevron-left"></i></a>
            </li>
            <li class="page-item active"><span class="page-link shadow-none">${current} / ${total || 1}</span></li>
            <li class="page-item ${current >= total ? 'disabled' : ''}">
                <a class="page-link shadow-none" href="javascript:loadAuditLogs(${current + 1})"><i class="bi bi-chevron-right"></i></a>
            </li>
        `;
    }

    document.addEventListener('DOMContentLoaded', () => loadAuditLogs(1));
    document.getElementById('auditAction').addEventListener('keypress', e => { if (e.key === 'Enter') loadAuditLogs(1); });
</script>
{% endblock %}
{% endblock %}