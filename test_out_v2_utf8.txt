============================= test session starts =============================
platform win32 -- Python 3.13.0, pytest-9.0.1, pluggy-1.6.0 -- E:\python\python313\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\lihuo\Desktop\重构\TG ONE
configfile: pytest.ini
plugins: anyio-4.12.1, asyncio-1.3.0, cov-7.0.0, mock-3.15.1, xdist-3.8.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... collected 5 items

tests/integration/test_auth_router.py::TestAuthRouter::test_login_success 
------------------------------- live log setup --------------------------------
2026-01-30 18:22:49 [    INFO] Failed to load SSL library: <class 'OSError'> (no library called "ssl" found)
2026-01-30 18:22:49 [    INFO] cryptg module not installed and libssl not found, falling back to (slower) Python encryption
2026-01-30 18:22:50 [    INFO] Bloom Filter (L0) 初始化成功
2026-01-30 18:22:50 [    INFO] HLL (HyperLogLog) 初始化成功
2026-01-30 18:22:50 [    INFO] SimHash 引擎与 LSH Forest 索引系统初始化成功
2026-01-30 18:22:50 [    INFO] Bloom Filter Service initialized using consolidated utils implementation
2026-01-30 18:22:50 [    INFO] 使用转发记录目录: C:\app\zhuanfaji
2026-01-30 18:22:50 [    INFO] ForwardRecorder 初始化完成，模式: full
2026-01-30 18:22:50 [    INFO] [Database] 初始化数据库连接，模式=共享引擎
2026-01-30 18:22:50 [    INFO] [Database] 使用共享引擎: sqlite+aiosqlite:///file:testdb_master?cache=shared&mode=memory&uri=true
2026-01-30 18:22:50 [    INFO] [Database] 会话工厂已初始化
2026-01-30 18:22:50 [    INFO] Container connected to shared database engine: sqlite+aiosqlite:///file:testdb_master?cache=shared&mode=memory&uri=true
2026-01-30 18:22:50 [    INFO] EventBus initialized
-------------------------------- live log call --------------------------------
2026-01-30 18:22:50 [    INFO] \U0001f310 [WebAPI] \u8bf7\u6c42\u5f00\u59cb: TraceID=c81877e6-ecf2-4b55-a4cd-8d30616bb628, IP=127.0.0.1, \u65b9\u6cd5=GET, \u8def\u5f84=/\n2026-01-30 18:22:50 [    INFO] \u2705 [WebAPI] \u8bf7\u6c42\u5b8c\u6210: TraceID=c81877e6-ecf2-4b55-a4cd-8d30616bb628, IP=127.0.0.1, \u65b9\u6cd5=GET, \u8def\u5f84=/, \u72b6\u6001\u7801=200, \u8017\u65f6=8.09ms\n2026-01-30 18:22:50 [    INFO] HTTP Request: GET http://test/ "HTTP/1.1 200 OK"
2026-01-30 18:22:50 [    INFO] \U0001f310 [WebAPI] \u8bf7\u6c42\u5f00\u59cb: TraceID=ecf59b2c-1731-4da9-8d93-b0e18f7d8256, IP=127.0.0.1, \u65b9\u6cd5=POST, \u8def\u5f84=/api/auth/login\n2026-01-30 18:22:50 [    INFO] 登录限流器已初始化
2026-01-30 18:22:50 [    INFO] \U0001f510 [Auth] \u7528\u6237\u8ba4\u8bc1\u8bf7\u6c42: \u7528\u6237\u540d=testuser\n2026-01-30 18:22:50 [    INFO] \u2705 [Auth] \u7528\u6237\u8ba4\u8bc1\u6210\u529f: \u7528\u6237\u540d=testuser, \u7528\u6237ID=1\n2026-01-30 18:22:50 [    INFO] 登录成功，已清除限流记录: username=testuser
2026-01-30 18:22:50 [    INFO] \U0001f195 [Auth] \u521b\u5efa\u4f1a\u8bdd: \u7528\u6237ID=1, IP=127.0.0.1\n2026-01-30 18:22:50 [    INFO] \u2705 [Auth] \u4f1a\u8bdd\u521b\u5efa\u6210\u529f: \u7528\u6237ID=1, IP=127.0.0.1, \u4f1a\u8bddID=5c403878-46ca-4f08-b39c-53609da53364\n2026-01-30 18:22:50 [    INFO] \u2705 [WebAPI] \u8bf7\u6c42\u5b8c\u6210: TraceID=ecf59b2c-1731-4da9-8d93-b0e18f7d8256, IP=127.0.0.1, \u65b9\u6cd5=POST, \u8def\u5f84=/api/auth/login, \u72b6\u6001\u7801=200, \u8017\u65f6=92.54ms\n2026-01-30 18:22:50 [    INFO] HTTP Request: POST http://test/api/auth/login "HTTP/1.1 200 OK"
PASSED                                                                   [ 20%]
tests/integration/test_auth_router.py::TestAuthRouter::test_login_invalid_credentials 
-------------------------------- live log call --------------------------------
2026-01-30 18:22:50 [    INFO] \U0001f310 [WebAPI] \u8bf7\u6c42\u5f00\u59cb: TraceID=9a636315-2454-4165-9d28-5868c0e952e8, IP=127.0.0.1, \u65b9\u6cd5=GET, \u8def\u5f84=/\n2026-01-30 18:22:50 [    INFO] \u2705 [WebAPI] \u8bf7\u6c42\u5b8c\u6210: TraceID=9a636315-2454-4165-9d28-5868c0e952e8, IP=127.0.0.1, \u65b9\u6cd5=GET, \u8def\u5f84=/, \u72b6\u6001\u7801=200, \u8017\u65f6=0.59ms\n2026-01-30 18:22:50 [    INFO] HTTP Request: GET http://test/ "HTTP/1.1 200 OK"
2026-01-30 18:22:50 [    INFO] \U0001f310 [WebAPI] \u8bf7\u6c42\u5f00\u59cb: TraceID=4355ec8e-b381-48e6-9784-fe624c2d7cc3, IP=127.0.0.1, \u65b9\u6cd5=POST, \u8def\u5f84=/api/auth/login\n2026-01-30 18:22:50 [    INFO] \U0001f510 [Auth] \u7528\u6237\u8ba4\u8bc1\u8bf7\u6c42: \u7528\u6237\u540d=wrong\n2026-01-30 18:22:50 [ WARNING] \u26a0\ufe0f [Auth] \u7528\u6237\u8ba4\u8bc1\u5931\u8d25: \u7528\u6237\u540d\u4e0d\u5b58\u5728\uff0c\u7528\u6237\u540d=wrong\n2026-01-30 18:22:50 [ WARNING] 登录失败: username=wrong, ip=127.0.0.1, attempts=1/5
2026-01-30 18:22:50 [    INFO] \u2705 [WebAPI] \u8bf7\u6c42\u5b8c\u6210: TraceID=4355ec8e-b381-48e6-9784-fe624c2d7cc3, IP=127.0.0.1, \u65b9\u6cd5=POST, \u8def\u5f84=/api/auth/login, \u72b6\u6001\u7801=401, \u8017\u65f6=3.01ms\n2026-01-30 18:22:50 [    INFO] HTTP Request: POST http://test/api/auth/login "HTTP/1.1 401 Unauthorized"
PASSED                                                                   [ 40%]
tests/integration/test_auth_router.py::TestAuthRouter::test_register_flow 
-------------------------------- live log call --------------------------------
2026-01-30 18:22:50 [    INFO] \U0001f310 [WebAPI] \u8bf7\u6c42\u5f00\u59cb: TraceID=fd84a832-77de-4e11-ae7e-67a10037d1c1, IP=127.0.0.1, \u65b9\u6cd5=GET, \u8def\u5f84=/\n2026-01-30 18:22:50 [    INFO] \u2705 [WebAPI] \u8bf7\u6c42\u5b8c\u6210: TraceID=fd84a832-77de-4e11-ae7e-67a10037d1c1, IP=127.0.0.1, \u65b9\u6cd5=GET, \u8def\u5f84=/, \u72b6\u6001\u7801=200, \u8017\u65f6=0.54ms\n2026-01-30 18:22:50 [    INFO] HTTP Request: GET http://test/ "HTTP/1.1 200 OK"
2026-01-30 18:22:50 [    INFO] \U0001f310 [WebAPI] \u8bf7\u6c42\u5f00\u59cb: TraceID=222f2e51-bad3-4105-a38a-8121f111e006, IP=127.0.0.1, \u65b9\u6cd5=POST, \u8def\u5f84=/api/auth/register\n2026-01-30 18:22:50 [    INFO] New user registered: username=newuser
2026-01-30 18:22:50 [    INFO] \u2705 [WebAPI] \u8bf7\u6c42\u5b8c\u6210: TraceID=222f2e51-bad3-4105-a38a-8121f111e006, IP=127.0.0.1, \u65b9\u6cd5=POST, \u8def\u5f84=/api/auth/register, \u72b6\u6001\u7801=200, \u8017\u65f6=86.91ms\n2026-01-30 18:22:50 [    INFO] HTTP Request: POST http://test/api/auth/register "HTTP/1.1 200 OK"
PASSED                                                                   [ 60%]
tests/integration/test_auth_router.py::TestAuthRouter::test_logout 
-------------------------------- live log call --------------------------------
2026-01-30 18:22:50 [    INFO] \U0001f310 [WebAPI] \u8bf7\u6c42\u5f00\u59cb: TraceID=4d06e87d-4bac-4f5c-a9da-2230e0b3f029, IP=127.0.0.1, \u65b9\u6cd5=GET, \u8def\u5f84=/\n2026-01-30 18:22:50 [    INFO] \u2705 [WebAPI] \u8bf7\u6c42\u5b8c\u6210: TraceID=4d06e87d-4bac-4f5c-a9da-2230e0b3f029, IP=127.0.0.1, \u65b9\u6cd5=GET, \u8def\u5f84=/, \u72b6\u6001\u7801=200, \u8017\u65f6=0.55ms\n2026-01-30 18:22:50 [    INFO] HTTP Request: GET http://test/ "HTTP/1.1 200 OK"
2026-01-30 18:22:50 [    INFO] \U0001f310 [WebAPI] \u8bf7\u6c42\u5f00\u59cb: TraceID=6327c78a-897d-4bbd-90c5-ed0b21ba9b04, IP=127.0.0.1, \u65b9\u6cd5=POST, \u8def\u5f84=/api/auth/logout\n2026-01-30 18:22:50 [    INFO] \u2705 [WebAPI] \u8bf7\u6c42\u5b8c\u6210: TraceID=6327c78a-897d-4bbd-90c5-ed0b21ba9b04, IP=127.0.0.1, \u65b9\u6cd5=POST, \u8def\u5f84=/api/auth/logout, \u72b6\u6001\u7801=200, \u8017\u65f6=1.37ms\n2026-01-30 18:22:50 [    INFO] HTTP Request: POST http://test/api/auth/logout "HTTP/1.1 200 OK"
PASSED                                                                   [ 80%]
tests/integration/test_auth_router.py::TestAuthRouter::test_refresh_token 
-------------------------------- live log call --------------------------------
2026-01-30 18:22:50 [    INFO] \U0001f310 [WebAPI] \u8bf7\u6c42\u5f00\u59cb: TraceID=382eccc6-f9fb-4df0-a5b6-73fa255e1fd3, IP=127.0.0.1, \u65b9\u6cd5=GET, \u8def\u5f84=/\n2026-01-30 18:22:50 [    INFO] \u2705 [WebAPI] \u8bf7\u6c42\u5b8c\u6210: TraceID=382eccc6-f9fb-4df0-a5b6-73fa255e1fd3, IP=127.0.0.1, \u65b9\u6cd5=GET, \u8def\u5f84=/, \u72b6\u6001\u7801=200, \u8017\u65f6=0.75ms\n2026-01-30 18:22:50 [    INFO] HTTP Request: GET http://test/ "HTTP/1.1 200 OK"
2026-01-30 18:22:50 [    INFO] \U0001f310 [WebAPI] \u8bf7\u6c42\u5f00\u59cb: TraceID=aea8f0cb-c7e7-4170-8b68-df068b82ebc6, IP=127.0.0.1, \u65b9\u6cd5=POST, \u8def\u5f84=/api/auth/login\n2026-01-30 18:22:50 [    INFO] \U0001f510 [Auth] \u7528\u6237\u8ba4\u8bc1\u8bf7\u6c42: \u7528\u6237\u540d=refuser\n2026-01-30 18:22:51 [    INFO] \u2705 [Auth] \u7528\u6237\u8ba4\u8bc1\u6210\u529f: \u7528\u6237\u540d=refuser, \u7528\u6237ID=1\n2026-01-30 18:22:51 [    INFO] 登录成功，已清除限流记录: username=refuser
2026-01-30 18:22:51 [    INFO] \U0001f195 [Auth] \u521b\u5efa\u4f1a\u8bdd: \u7528\u6237ID=1, IP=127.0.0.1\n2026-01-30 18:22:51 [    INFO] \u2705 [Auth] \u4f1a\u8bdd\u521b\u5efa\u6210\u529f: \u7528\u6237ID=1, IP=127.0.0.1, \u4f1a\u8bddID=beecbdbe-14bc-467d-86cb-e2a01dda769a\n2026-01-30 18:22:51 [    INFO] \u2705 [WebAPI] \u8bf7\u6c42\u5b8c\u6210: TraceID=aea8f0cb-c7e7-4170-8b68-df068b82ebc6, IP=127.0.0.1, \u65b9\u6cd5=POST, \u8def\u5f84=/api/auth/login, \u72b6\u6001\u7801=200, \u8017\u65f6=84.41ms\n2026-01-30 18:22:51 [    INFO] HTTP Request: POST http://test/api/auth/login "HTTP/1.1 200 OK"
2026-01-30 18:22:52 [ WARNING] CSRF token validation failed for POST /api/auth/refresh: CSRF Token Verification Failed
2026-01-30 18:22:52 [    INFO] HTTP Request: POST http://test/api/auth/refresh "HTTP/1.1 403 Forbidden"
FAILED                                                                   [100%]

================================== FAILURES ===================================
______________________ TestAuthRouter.test_refresh_token ______________________
tests\integration\test_auth_router.py:82: in test_refresh_token
    assert resp.status_code == 200
E   assert 403 == 200
E    +  where 403 = <Response [403 Forbidden]>.status_code
------------------------------ Captured log call ------------------------------
INFO     web_admin.middlewares.trace_middleware:trace_middleware.py:26 \U0001f310 [WebAPI] \u8bf7\u6c42\u5f00\u59cb: TraceID=382eccc6-f9fb-4df0-a5b6-73fa255e1fd3, IP=127.0.0.1, \u65b9\u6cd5=GET, \u8def\u5f84=/\nINFO     web_admin.middlewares.trace_middleware:trace_middleware.py:47 \u2705 [WebAPI] \u8bf7\u6c42\u5b8c\u6210: TraceID=382eccc6-f9fb-4df0-a5b6-73fa255e1fd3, IP=127.0.0.1, \u65b9\u6cd5=GET, \u8def\u5f84=/, \u72b6\u6001\u7801=200, \u8017\u65f6=0.75ms\nINFO     httpx:_client.py:1740 HTTP Request: GET http://test/ "HTTP/1.1 200 OK"\nINFO     web_admin.middlewares.trace_middleware:trace_middleware.py:26 \U0001f310 [WebAPI] \u8bf7\u6c42\u5f00\u59cb: TraceID=aea8f0cb-c7e7-4170-8b68-df068b82ebc6, IP=127.0.0.1, \u65b9\u6cd5=POST, \u8def\u5f84=/api/auth/login\nINFO     services.authentication_service:authentication_service.py:26 \U0001f510 [Auth] \u7528\u6237\u8ba4\u8bc1\u8bf7\u6c42: \u7528\u6237\u540d=refuser\nINFO     services.authentication_service:authentication_service.py:44 \u2705 [Auth] \u7528\u6237\u8ba4\u8bc1\u6210\u529f: \u7528\u6237\u540d=refuser, \u7528\u6237ID=1\nINFO     web_admin.security.rate_limiter:rate_limiter.py:181 \u767b\u5f55\u6210\u529f\uff0c\u5df2\u6e05\u9664\u9650\u6d41\u8bb0\u5f55: username=refuser\nINFO     services.authentication_service:authentication_service.py:84 \U0001f195 [Auth] \u521b\u5efa\u4f1a\u8bdd: \u7528\u6237ID=1, IP=127.0.0.1\nINFO     services.authentication_service:authentication_service.py:109 \u2705 [Auth] \u4f1a\u8bdd\u521b\u5efa\u6210\u529f: \u7528\u6237ID=1, IP=127.0.0.1, \u4f1a\u8bddID=beecbdbe-14bc-467d-86cb-e2a01dda769a\nINFO     web_admin.middlewares.trace_middleware:trace_middleware.py:47 \u2705 [WebAPI] \u8bf7\u6c42\u5b8c\u6210: TraceID=aea8f0cb-c7e7-4170-8b68-df068b82ebc6, IP=127.0.0.1, \u65b9\u6cd5=POST, \u8def\u5f84=/api/auth/login, \u72b6\u6001\u7801=200, \u8017\u65f6=84.41ms\nINFO     httpx:_client.py:1740 HTTP Request: POST http://test/api/auth/login "HTTP/1.1 200 OK"\nWARNING  web_admin.security.csrf:csrf.py:34 CSRF token validation failed for POST /api/auth/refresh: CSRF Token Verification Failed\nINFO     httpx:_client.py:1740 HTTP Request: POST http://test/api/auth/refresh "HTTP/1.1 403 Forbidden"
=========================== short test summary info ===========================
FAILED tests/integration/test_auth_router.py::TestAuthRouter::test_refresh_token - assert 403 == 200
 +  where 403 = <Response [403 Forbidden]>.status_code
========================= 1 failed, 4 passed in 2.56s =========================
