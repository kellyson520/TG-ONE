# 菜单系统与业务逻辑深度审计

## 背景 (Context)
用户要求深入检查菜单系统的交互错误、显示错误及逻辑运行错误。重点关注：
1. **历史消息获取**: 采集逻辑、进度展示、过滤准确性。
2. **消息重复删除**: 扫描算法、删除执行安全性、UI 状态同步。

## 策略 (Strategy)
采用 **"全链路审计法"**:
1. **Entry Audit**: 检查 Telegram Callback 按钮路径与数据长度。
2. **Logic Audit**: 静态分析 Service 层异步逻辑与异常处理。
3. **State Audit**: 检查任务运行状态在数据库与 UI 间的同步。
4. **Boundary Audit**: 测试边界情况（如无消息、超大消息组、API 限速）。

## 待办清单 (Checklist)

### Phase 1: 历史消息获取深度检查 📜
- [x] **P1.1**: 审计 `HistoryMessageService` 的扫描逻辑（偏移量、限速处理）。
- [x] **P1.2**: 检查历史消息菜单中的日期/时间选择器，验证数据传递准确性。
- [x] **P1.3**: 验证历史消息任务的进度更新机制（是否会卡死在 0% 或 99%）。
- [x] **P1.4**: 检查历史消息转发时的过滤规则应用（是否正确触发了关键词/媒体过滤）。

### Phase 2: 消息重复删除深度检查 🗑️
- [x] **P2.1**: 审计 `SessionService` 中的重复扫描算法（Signature 生成与对比）。
- [x] **P2.2**: 检查重复项选择 UI，验证批量选择与删除的勾选状态。
- [x] **P2.3**: 验证删除执行的原子性，确保失败时有重试或清晰的报错。
- [x] **P2.4**: 检查删除过程中的 Telegram API 限速 (Flood) 处理。

### Phase 3: 菜单交互与逻辑综合检查 ⚙️
- [x] **P3.1**: 检查全局 Callback Data 长度，确保业务数据未使按钮失效。
- [x] **P3.2**: 审计菜单跳转中的 "返回上一级" 路径，清理重复或死循环。
- [x] **P3.3**: 检查所有 "虚假数据" 占位符，确保已接入真实统计。
- [x] **P3.4**: 验证长耗时操作（如扫描、备份）的 "处理中..." 状态展示。

### Phase 4: 修复与验证 ✅
- [x] **P4: 修复逻辑不一致性与集成测试** (已完成)
    - [x] P4.1 修复 `MenuController.start_history_task` 等方法的依赖和参数错误 (Step 71)
    - [x] P4.2 修复 `SessionService` 状态存储结构 (移除 `chat_states` 中间层) (Step 79)
    - [x] P4.3 修复 `SessionService.scan_duplicate_messages` 中的 ID 赋值错误 (Step 79)
    - [x] P4.4 在 `bot_handler.py` 中重新集成 `handle_prompt_setting` (Step 84)
    - [x] P4.5 统一全文 `chat_id` 使用，移除所有滥用的 `abs()` (Step 174-198)
- [x] **P5: 验证与验收** (已完成)
    - [x] P5.1 验证状态持久化恢复时的 ID 类型转换 (Step 116)
    - [x] P5.2 验证关键词添加/AI提示词设置的闭环逻辑 (代码逻辑审计通过)
- [x] **P4.6**: 运行针对性单元测试。
- [x] **P4.7**: 提交最终审计报告。

## 优先级说明
- **P0 (Critical)**: 数据删除安全性、任务进度卡死修复。
- **P1 (High)**: 过滤规则准确性、UI 状态同步。
- **P2 (Medium)**: 交互微调、长路径优化。
