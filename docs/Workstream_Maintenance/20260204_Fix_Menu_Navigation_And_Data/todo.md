# 修复菜单导航失效与数据虚假展示问题

## 背景 (Context)

用户报告了三个关键问题：
1. **导航失效**: Bot菜单规则管理页面点击"返回上一级"按钮无反应
2. **数据虚假**: 系统设置中心展示的数据都是硬编码的占位符，未真正接入数据库
3. **归档崩溃**: 定时任务归档失败，提示 TaskQueue 实例已被删除

这些问题严重影响用户体验和系统可靠性，需要立即修复。

## 策略 (Strategy)

采用**三层诊断修复法**：
1. **导航层**: 检查回调路由注册、事件处理器绑定
2. **数据层**: 审计所有菜单数据源，替换硬编码为真实数据库查询
3. **稳定层**: 修复 SQLAlchemy Session 管理问题，防止实例过期

## 待办清单 (Checklist)

### Phase 1: 导航失效诊断与修复 🔍
- [x] **P1.1**: 定位"返回上一级"按钮的 callback_data 格式
- [x] **P1.2**: 检查对应的回调处理器是否已注册
- [x] **P1.3**: 验证事件处理器绑定是否正确
- [x] **P1.4**: 添加调试日志追踪按钮点击事件
- [x] **P1.5**: 修复导航逻辑并测试

### Phase 2: 数据虚假展示修复 📊
- [x] **P2.1**: 审计系统设置中心的数据源（转发规则、去重、记录状态）
- [x] **P2.2**: 替换硬编码"未知"为真实数据库查询
- [x] **P2.3**: 实现规则统计查询（总数、启用数）
- [x] **P2.4**: 实现去重配置状态查询
- [x] **P2.5**: 实现数据记录状态查询
- [x] **P2.6**: 更新菜单渲染逻辑使用真实数据

### Phase 3: 数据库归档崩溃修复 🛡️
- [x] **P3.1**: 分析 TaskQueue 实例过期的根本原因
- [x] **P3.2**: 检查 Session 生命周期管理
- [x] **P3.3**: 修复归档任务的 Session 刷新逻辑
- [x] **P3.4**: 添加实例有效性检查
- [x] **P3.5**: 实现优雅降级（归档失败不应崩溃）

### Phase 4: 验证与测试 ✅
- [ ] **P4.1**: 单元测试：菜单导航回调处理器
- [ ] **P4.2**: 集成测试：系统设置中心数据展示
- [ ] **P4.3**: 手动测试：点击返回按钮验证导航
- [ ] **P4.4**: 监控测试：观察归档任务运行 30 分钟无错误

## 优先级说明
- **P0 (Critical)**: Phase 1 导航修复 - 影响基本可用性
- **P1 (High)**: Phase 2 数据展示 - 影响用户信任度
- **P2 (Medium)**: Phase 3 归档修复 - 影响系统稳定性
