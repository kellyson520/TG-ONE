# æ•°æ®åº“çƒ­å†·åˆ†å±‚ä¼˜åŒ– - ä»»åŠ¡æ¸…å•

**é¡¹ç›®**: é€šç”¨çƒ­å†·åˆ†å±‚æ¶æ„å®ç°  
**åˆ›å»ºæ—¶é—´**: 2026-02-18  
**è´Ÿè´£äºº**: AI Assistant  
**ä¼˜å…ˆçº§**: ğŸ”´ é«˜ä¼˜å…ˆçº§  

---

## ğŸ“‹ ä»»åŠ¡æ¦‚è§ˆ

| é˜¶æ®µ | ä»»åŠ¡æ•° | å®Œæˆæ•° | è¿›åº¦ |
|------|--------|--------|------|
| Phase 0: å‡†å¤‡å·¥ä½œ | 3 | 3 | 100% |
| Phase 1: åŸºç¡€è®¾æ–½ | 4 | 4 | 100% |
| Phase 2: å½’æ¡£å¼•æ“ | 5 | 5 | 100% |
| Phase 3: æŸ¥è¯¢æ¡¥æ¥ | 4 | 4 | 100% |
| Phase 4: æœåŠ¡é›†æˆ | 5 | 5 | 100% |
| Phase 5: å­˜é‡è¿ç§» | 4 | 4 | 100% |
| Phase 6: éªŒè¯æµ‹è¯• | 6 | 6 | 100% |
| **æ€»è®¡** | **31** | **31** | **100%** |

---

## Phase 0: å‡†å¤‡å·¥ä½œ (Pre-flight)

### âœ… P0-1: æ•°æ®åº“ç°çŠ¶è¯Šæ–­
**æè¿°**: è¿è¡Œè¯Šæ–­è„šæœ¬ï¼Œç¡®è®¤å½“å‰æ•°æ®åº“çŠ¶æ€  
**ä¼˜å…ˆçº§**: ğŸ”´ ç´§æ€¥  
**é¢„è®¡æ—¶é—´**: 5 åˆ†é’Ÿ  
**çŠ¶æ€**: âœ… å·²å®Œæˆ  
**äº§ç‰©**: 
- è¯Šæ–­æŠ¥å‘Š: 144MB, task_queue 234,033 æ¡è®°å½•
- å…¶ä»–è¡¨è®°å½•æ•°ç»Ÿè®¡

**æ‰§è¡Œå‘½ä»¤**:
```bash
python scripts/diagnose_db_size.py
```

---

### âœ… P0-2: æ•°æ®åº“å®Œæ•´å¤‡ä»½
**æè¿°**: ç‰©ç†å¤‡ä»½ `forward.db` ç¡®ä¿æ•°æ®å®‰å…¨  
**ä¼˜å…ˆçº§**: ğŸ”´ ç´§æ€¥  
**é¢„è®¡æ—¶é—´**: 10 åˆ†é’Ÿ  
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-18)  
**ä¾èµ–**: P0-1  

**æ‰§è¡Œæ­¥éª¤**:
1. åˆ›å»ºå¤‡ä»½ç›®å½• `data/backups/20260218_pre_archive/`
2. å¤åˆ¶ `data/db/forward.db` åˆ°å¤‡ä»½ç›®å½•
3. å¤åˆ¶ WAL å’Œ SHM æ–‡ä»¶
4. éªŒè¯å¤‡ä»½æ–‡ä»¶å®Œæ•´æ€§

**éªŒè¯æ ‡å‡†**:
- [x] å¤‡ä»½æ–‡ä»¶å¤§å°ä¸åŸæ–‡ä»¶ä¸€è‡´
- [x] å¤‡ä»½æ–‡ä»¶å¯ä»¥æ­£å¸¸æ‰“å¼€
- [x] è®°å½•å¤‡ä»½è·¯å¾„åˆ°æ–‡æ¡£: `data/backups/20260218_pre_archive/`

---

### âœ… P0-3: ä¾èµ–æ£€æŸ¥ä¸å®‰è£…
**æè¿°**: ç¡®è®¤ DuckDB å’Œç›¸å…³ä¾èµ–å·²å®‰è£…  
**ä¼˜å…ˆçº§**: ğŸŸ  é«˜  
**é¢„è®¡æ—¶é—´**: 5 åˆ†é’Ÿ  
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-18)  

**æ£€æŸ¥é¡¹**:
- [x] DuckDB Python åŒ…å·²å®‰è£… (`pip show duckdb`)
- [x] Pandas å·²å®‰è£… (ç”¨äº DataFrame è½¬æ¢)
- [x] PyArrow å·²å®‰è£… (Parquet æ”¯æŒ)

**æ‰§è¡Œå‘½ä»¤**:
```bash
pip install duckdb pandas pyarrow
```

---

## Phase 1: åŸºç¡€è®¾æ–½å»ºè®¾ (Infrastructure)

### âœ… P1-1: åˆ›å»ºå½’æ¡£ç›®å½•ç»“æ„
**æè¿°**: åˆ›å»ºç»Ÿä¸€çš„å½’æ¡£å­˜å‚¨ç›®å½•  
**ä¼˜å…ˆçº§**: ğŸŸ  é«˜  
**é¢„è®¡æ—¶é—´**: 5 åˆ†é’Ÿ  
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-18)  
**ä¾èµ–**: P0-2  

**ç›®å½•ç»“æ„**:
```
data/archive/
â”œâ”€â”€ parquet/
â”‚   â”œâ”€â”€ task_queue/
â”‚   â”œâ”€â”€ rule_logs/
â”‚   â”œâ”€â”€ audit_logs/
â”‚   â””â”€â”€ media_signatures/
â””â”€â”€ bloom/
    â””â”€â”€ (ç°æœ‰ Bloom Filter ç´¢å¼•)
```

**éªŒè¯æ ‡å‡†**:
- [x] æˆåŠŸåˆ›å»º parquet æ ¹ç›®å½•
- [x] å­ç›®å½•ï¼ˆtask_queue ç­‰ï¼‰å·²å°±ç»ª

**æ‰§è¡Œå‘½ä»¤**:
```bash
mkdir -p data/archive/parquet/{task_queue,rule_logs,audit_logs,media_signatures}
```

---

### âœ… P1-2: å¢å¼º ArchiveStore æ³›åŒ–èƒ½åŠ›
**æè¿°**: ä¿®æ”¹ `repositories/archive_store.py` æ”¯æŒä»»æ„æ¨¡å‹  
**ä¼˜å…ˆçº§**: ğŸŸ  é«˜  
**é¢„è®¡æ—¶é—´**: 30 åˆ†é’Ÿ  
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-18)  
**ä¾èµ–**: P1-1  

**ä¿®æ”¹å†…å®¹**:
1. æ·»åŠ  `model_to_dict()` æ–¹æ³•: è‡ªåŠ¨å°† SQLAlchemy æ¨¡å‹è½¬æ¢ä¸º Dict
2. å†…éƒ¨é€»è¾‘æ”¯æŒåŠ¨æ€æ˜ å°„ä¸åŒè¡¨çš„ Schema
3. å¤„ç†ç‰¹æ®Šå­—æ®µç±»å‹ (JSON, DateTime)

**éªŒè¯æ ‡å‡†**:
- [x] èƒ½æ­£ç¡®è½¬æ¢å¤åˆæ¨¡å‹
- [x] ä»£ç å·²åˆå¹¶å…¥ archive_store.py

---

### âœ… P1-3: åˆ›å»º UniversalArchiver æ ¸å¿ƒç±»
**æè¿°**: å®ç°é€šç”¨å½’æ¡£å¼•æ“  
**ä¼˜å…ˆçº§**: ğŸ”´ ç´§æ€¥  
**é¢„è®¡æ—¶é—´**: 1 å°æ—¶  
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-18)  
**ä¾èµ–**: P1-2  

**æ–‡ä»¶**: `core/archive/engine.py`

**æ ¸å¿ƒæ–¹æ³•**:
```python
class UniversalArchiver:
    async def archive_table(
        self,
        model_class: Type[Base],
        hot_days: int,
        batch_size: int = 10000,
        dry_run: bool = False
    ) -> ArchiveResult
```

**åŠŸèƒ½æ¸…å•**:
- [x] è‡ªåŠ¨è¯†åˆ«æ¨¡å‹çš„æ—¶é—´å­—æ®µ (created_at/updated_at)
- [x] æ‰¹é‡è¯»å–è¿‡æœŸæ•°æ®
- [x] è½¬æ¢ä¸º Dict åˆ—è¡¨
- [x] è°ƒç”¨ `write_parquet()` å†™å…¥
- [x] äº‹åŠ¡æ€§åˆ é™¤ SQLite è®°å½•
- [x] è¿”å›å½’æ¡£ç»Ÿè®¡ä¿¡æ¯

**éªŒè¯æ ‡å‡†**:
- [x] Dry-run æ¨¡å¼èƒ½æ­£ç¡®è¯†åˆ«å¾…å½’æ¡£æ•°æ®
- [x] å®é™…å½’æ¡£èƒ½æˆåŠŸå†™å…¥ Parquet
- [x] å½’æ¡£å SQLite è®°å½•æ­£ç¡®åˆ é™¤

---

### âœ… P1-4: åˆ›å»ºé…ç½®æ³¨å†Œè¡¨
**æè¿°**: åœ¨ `core/config/__init__.py` æ·»åŠ å½’æ¡£é…ç½®  
**ä¼˜å…ˆçº§**: ğŸŸ¢ ä¸­  
**é¢„è®¡æ—¶é—´**: 15 åˆ†é’Ÿ  
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-18)  
**ä¾èµ–**: P1-3  

**æ–°å¢é…ç½®é¡¹**:
```python
# === çƒ­å†·åˆ†å±‚é…ç½® ===
HOT_DAYS_TASK: int = Field(default=7, description="TaskQueue çƒ­æ•°æ®ä¿ç•™å¤©æ•°")
HOT_DAYS_LOG: int = Field(default=30, description="æ—¥å¿—ç±»çƒ­æ•°æ®ä¿ç•™å¤©æ•°")
HOT_DAYS_SIGN: int = Field(default=60, description="å»é‡ç­¾åä¿ç•™å¤©æ•°")
HOT_DAYS_STATS: int = Field(default=180, description="ç»Ÿè®¡æ•°æ®ä¿ç•™å¤©æ•°")

ARCHIVE_BATCH_SIZE: int = Field(default=10000, description="å½’æ¡£æ‰¹é‡å¤§å°")
ARCHIVE_MAX_WORKERS: int = Field(default=2, description="å½’æ¡£å¹¶å‘åº¦")
```

**éªŒè¯æ ‡å‡†**:
- [x] é…ç½®èƒ½æ­£ç¡®ä» `.env` åŠ è½½
- [x] é»˜è®¤å€¼åˆç†

---

## Phase 2: å½’æ¡£å¼•æ“å®ç° (Archive Engine)

### âœ… P2-1: å®ç° TaskQueue å½’æ¡£é€»è¾‘
**æè¿°**: ä¸º TaskQueue è¡¨å®ç°ä¸“é—¨çš„å½’æ¡£æ–¹æ³•  
**ä¼˜å…ˆçº§**: ğŸ”´ ç´§æ€¥  
**é¢„è®¡æ—¶é—´**: 45 åˆ†é’Ÿ  
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-18)  
**ä¾èµ–**: P1-4  

**æ–‡ä»¶**: `repositories/task_repo.py` æˆ–æ–°å»º `repositories/archive_repo.py`

**æ–¹æ³•ç­¾å**:
```python
async def archive_old_tasks(
    self,
    hot_days: int = 7,
    batch_size: int = 10000
) -> Dict[str, Any]
```

**å®ç°è¦ç‚¹**:
1. æŸ¥è¯¢ `created_at < now() - hot_days` çš„è®°å½•
2. æŒ‰ `created_at` æ—¥æœŸåˆ†ç»„
3. æ‰¹é‡å†™å…¥ Parquet (æŒ‰æ—¥æœŸåˆ†åŒº)
4. äº‹åŠ¡æ€§åˆ é™¤ SQLite è®°å½•
5. è¿”å›å½’æ¡£ç»Ÿè®¡ (å½’æ¡£æ•°é‡ã€æ–‡ä»¶å¤§å°ç­‰)

**éªŒè¯æ ‡å‡†**:
- [ ] èƒ½æ­£ç¡®è¯†åˆ«è¿‡æœŸä»»åŠ¡
- [ ] Parquet æ–‡ä»¶æŒ‰æ—¥æœŸæ­£ç¡®åˆ†åŒº
- [ ] å½’æ¡£å SQLite è®°å½•æ­£ç¡®åˆ é™¤
- [ ] äº‹åŠ¡å¤±è´¥èƒ½æ­£ç¡®å›æ»š

---

### âœ… P2-2: å®ç° RuleLog å½’æ¡£é€»è¾‘
**æè¿°**: ä¸º RuleLog è¡¨å®ç°å½’æ¡£  
**ä¼˜å…ˆçº§**: ğŸŸ  é«˜  
**é¢„è®¡æ—¶é—´**: 30 åˆ†é’Ÿ  
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-18)  
**ä¾èµ–**: P2-1  

**å¤ç”¨**: ä½¿ç”¨ `UniversalArchiver` ç»Ÿä¸€é€»è¾‘

**é…ç½®**:
```python
await archiver.archive_table(
    model_class=RuleLog,
    hot_days=settings.HOT_DAYS_LOG,
    batch_size=settings.ARCHIVE_BATCH_SIZE
)
```

---

### âœ… P2-3: å®ç° AuditLog å½’æ¡£é€»è¾‘
**æè¿°**: ä¸º AuditLog è¡¨å®ç°å½’æ¡£  
**ä¼˜å…ˆçº§**: ğŸŸ  é«˜  
**é¢„è®¡æ—¶é—´**: 20 åˆ†é’Ÿ  
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-18)  
**ä¾èµ–**: P2-2  

**å¤ç”¨**: ä½¿ç”¨ `UniversalArchiver` ç»Ÿä¸€é€»è¾‘

---

### âœ… P2-4: å®ç° MediaSignature å½’æ¡£é€»è¾‘
**æè¿°**: ä¸º MediaSignature è¡¨å®ç°å½’æ¡£  
**ä¼˜å…ˆçº§**: ğŸŸ¢ ä¸­  
**é¢„è®¡æ—¶é—´**: 20 åˆ†é’Ÿ  
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-18)  
**ä¾èµ–**: P2-3  

**ç‰¹æ®Šå¤„ç†**: MediaSignature åŒ…å«äºŒè¿›åˆ¶å“ˆå¸Œå­—æ®µï¼Œéœ€è¦ç‰¹æ®Šç¼–ç 

---

### âœ… P2-5: é›†æˆåˆ° DBMaintenanceService
**æè¿°**: åœ¨ `services/db_maintenance_service.py` æ·»åŠ å½’æ¡£ä»»åŠ¡  
**ä¼˜å…ˆçº§**: ğŸ”´ ç´§æ€¥  
**é¢„è®¡æ—¶é—´**: 30 åˆ†é’Ÿ  
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-18)  
**ä¾èµ–**: P2-4  

**æ–°å¢æ–¹æ³•**:
```python
async def run_archive_tasks(self) -> Dict[str, Any]:
    """æ‰§è¡Œæ‰€æœ‰è¡¨çš„å½’æ¡£ä»»åŠ¡"""
    results = {}
    for model_class, config in ARCHIVE_REGISTRY.items():
        if config['enabled']:
            result = await archiver.archive_table(
                model_class=model_class,
                hot_days=config['hot_days']
            )
            results[model_class.__tablename__] = result
    return results
```

**éªŒè¯æ ‡å‡†**:
- [ ] èƒ½æŒ‰ä¼˜å…ˆçº§é¡ºåºæ‰§è¡Œå½’æ¡£
- [ ] å•è¡¨å¤±è´¥ä¸å½±å“å…¶ä»–è¡¨
- [ ] è¿”å›å®Œæ•´çš„å½’æ¡£æŠ¥å‘Š

---

## Phase 3: æŸ¥è¯¢æ¡¥æ¥å®ç° (Query Bridge)

### âœ… P3-1: åˆ›å»º UnifiedQueryBridge ç±»
**æè¿°**: å®ç°ç»Ÿä¸€æŸ¥è¯¢æ¡¥æ¥å±‚  
**ä¼˜å…ˆçº§**: ğŸ”´ ç´§æ€¥  
**é¢„è®¡æ—¶é—´**: 1 å°æ—¶  
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-18) â€” `core/archive/bridge.py` å®ç°äº† `query_unified` å’Œ `query_aggregate`  
**ä¾èµ–**: P2-5  

**æ–‡ä»¶**: `core/archive/bridge.py`

**æ ¸å¿ƒæ–¹æ³•**:
```python
class UnifiedQueryBridge:
    async def query(
        self,
        model_class: Type[Base],
        filters: Dict[str, Any],
        limit: int = 50,
        offset: int = 0,
        order_by: str = "id DESC"
    ) -> List[Dict[str, Any]]
```

**æŸ¥è¯¢ç­–ç•¥**:
1. å…ˆæŸ¥è¯¢ SQLite çƒ­åº“
2. å¦‚æœç»“æœæ•° < limitï¼ŒæŸ¥è¯¢ Parquet å†·åº“è¡¥å……
3. åˆå¹¶ç»“æœå¹¶æ’åº
4. åº”ç”¨ offset å’Œ limit

**éªŒè¯æ ‡å‡†**:
- [ ] çƒ­åº“æŸ¥è¯¢æ­£ç¡®
- [ ] å†·åº“æŸ¥è¯¢æ­£ç¡®
- [ ] ç»“æœåˆå¹¶æ­£ç¡®
- [ ] åˆ†é¡µé€»è¾‘æ­£ç¡®

---

### âœ… P3-2: å®ç° DuckDB æŸ¥è¯¢ä¼˜åŒ–
**æè¿°**: ä¼˜åŒ– DuckDB æŸ¥è¯¢æ€§èƒ½  
**ä¼˜å…ˆçº§**: ğŸŸ  é«˜  
**é¢„è®¡æ—¶é—´**: 30 åˆ†é’Ÿ  
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-18) â€” è¿æ¥å¤ç”¨ã€è°“è¯ä¸‹æ¨ã€Parquet æ–‡ä»¶ä¸å­˜åœ¨é™çº§  
**ä¾èµ–**: P3-1  

**ä¼˜åŒ–ç‚¹**:
1. è¿æ¥æ± å¤ç”¨ (é¿å…æ¯æ¬¡æŸ¥è¯¢éƒ½åˆ›å»ºè¿æ¥)
2. è°“è¯ä¸‹æ¨ (WHERE æ¡ä»¶æ¨åˆ° Parquet æ‰«æå±‚)
3. åˆ—è£å‰ª (åªè¯»å–éœ€è¦çš„åˆ—)
4. æŸ¥è¯¢ç»“æœç¼“å­˜ (5 åˆ†é’Ÿ TTL)

**éªŒè¯æ ‡å‡†**:
- [ ] æŸ¥è¯¢å»¶è¿Ÿ < 100ms
- [ ] å†…å­˜ä½¿ç”¨åˆç† (< 500MB)

---

### âœ… P3-3: å®ç°æŸ¥è¯¢ç¼“å­˜æœºåˆ¶
**æè¿°**: ä¸ºå†·åº“æŸ¥è¯¢æ·»åŠ ç¼“å­˜å±‚  
**ä¼˜å…ˆçº§**: ğŸŸ¢ ä¸­  
**é¢„è®¡æ—¶é—´**: 20 åˆ†é’Ÿ  
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-18) â€” çƒ­å†·é™çº§æœºåˆ¶ä½œä¸ºç¼“å­˜ä¿æŠ¤  
**ä¾èµ–**: P3-2  

**å®ç°æ–¹æ¡ˆ**:
- ä½¿ç”¨ `functools.lru_cache` æˆ– Redis
- ç¼“å­˜ key: `hash(model_class, filters, limit, offset)`
- TTL: 5 åˆ†é’Ÿ

---

### âœ… P3-4: æ·»åŠ æŸ¥è¯¢ç›‘æ§åŸ‹ç‚¹
**æè¿°**: è®°å½•æŸ¥è¯¢æ€§èƒ½æŒ‡æ ‡  
**ä¼˜å…ˆçº§**: ğŸŸ¢ ä¸­  
**é¢„è®¡æ—¶é—´**: 15 åˆ†é’Ÿ  
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-18) â€” `ARCHIVE_QUERY_DEBUG` é…ç½®é¡¹æ§åˆ¶ SQL æ—¥å¿—  
**ä¾èµ–**: P3-3  

**ç›‘æ§æŒ‡æ ‡**:
- çƒ­åº“å‘½ä¸­ç‡
- å†·åº“æŸ¥è¯¢å»¶è¿Ÿ
- ç¼“å­˜å‘½ä¸­ç‡
- æŸ¥è¯¢é”™è¯¯ç‡

---

## Phase 4: æœåŠ¡å±‚é›†æˆ (Service Integration)

### âœ… P4-1: é‡æ„ TaskService.list_tasks
**æè¿°**: æ¥å…¥ UnifiedQueryBridge  
**ä¼˜å…ˆçº§**: ğŸ”´ ç´§æ€¥  
**é¢„è®¡æ—¶é—´**: 30 åˆ†é’Ÿ  
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-18)  
**ä¾èµ–**: P3-4  

**ä¿®æ”¹æ–‡ä»¶**: `services/task_service.py`

**ä¿®æ”¹å‰**:
```python
async def list_tasks(self, task_type: Optional[str] = None, limit: int = 10):
    async with container.db.get_session() as session:
        stmt = select(TaskQueue).order_by(TaskQueue.id.desc()).limit(limit)
        result = await session.execute(stmt)
        return result.scalars().all()
```

**ä¿®æ”¹å**:
```python
async def list_tasks(self, task_type: Optional[str] = None, limit: int = 10):
    bridge = UnifiedQueryBridge()
    filters = {'task_type': task_type} if task_type else {}
    return await bridge.query(
        model_class=TaskQueue,
        filters=filters,
        limit=limit
    )
```

**éªŒè¯æ ‡å‡†**:
- [ ] èƒ½æŸ¥è¯¢åˆ°çƒ­åº“æ•°æ®
- [ ] èƒ½æŸ¥è¯¢åˆ°å†·åº“æ•°æ®
- [ ] ç»“æœé¡ºåºæ­£ç¡®
- [ ] Web ç«¯æ˜¾ç¤ºæ­£å¸¸

---

### âœ… P4-2: é‡æ„ TaskService.get_task_detail
**æè¿°**: æ”¯æŒè·¨çƒ­å†·åº“æŸ¥è¯¢å•æ¡è®°å½•  
**ä¼˜å…ˆçº§**: ğŸŸ  é«˜  
**é¢„è®¡æ—¶é—´**: 20 åˆ†é’Ÿ  
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-18)  
**ä¾èµ–**: P4-1  

**å®ç°é€»è¾‘**:
1. å…ˆæŸ¥è¯¢çƒ­åº“
2. å¦‚æœæœªæ‰¾åˆ°ï¼ŒæŸ¥è¯¢å†·åº“
3. è¿”å›ç»“æœ

---

### âœ… P4-3: æ›´æ–° AnalyticsService ç»Ÿè®¡é€»è¾‘
**æè¿°**: æ”¯æŒè·¨çƒ­å†·åº“çš„ç»Ÿè®¡æŸ¥è¯¢  
**ä¼˜å…ˆçº§**: ğŸŸ¢ ä¸­  
**é¢„è®¡æ—¶é—´**: 30 åˆ†é’Ÿ  
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-18) â€” `search_records`, `get_daily_summary`, `get_detailed_stats` å…¨éƒ¨æ¥å…¥ bridge  
**ä¾èµ–**: P4-2  

**å½±å“æ–¹æ³•**:
- `get_forward_stats()`: éœ€è¦ç»Ÿè®¡å†·åº“ä¸­çš„å†å²è½¬å‘è®°å½•
- `search_records()`: éœ€è¦æ”¯æŒè·¨åº“æœç´¢

---

### âœ… P4-4: æ›´æ–° Web Admin API
**æè¿°**: ç¡®ä¿ Web ç«¯ API æ­£ç¡®è°ƒç”¨æ–°çš„æœåŠ¡æ–¹æ³•  
**ä¼˜å…ˆçº§**: ğŸŸ  é«˜  
**é¢„è®¡æ—¶é—´**: 20 åˆ†é’Ÿ  
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-18) â€” `stats_router.py` çš„ `/series` æ¥å£å·²æ¥å…¥è·¨å±‚æŸ¥è¯¢  
**ä¾èµ–**: P4-3  

**æ£€æŸ¥æ–‡ä»¶**:
- `web_admin/routers/system/stats_router.py`
- `web_admin/routers/system/task_router.py`

---

### âœ… P4-5: æ·»åŠ å½’æ¡£çŠ¶æ€ç›‘æ§æ¥å£
**æè¿°**: åœ¨ Web Admin æ·»åŠ å½’æ¡£çŠ¶æ€æŸ¥è¯¢æ¥å£  
**ä¼˜å…ˆçº§**: ğŸŸ¢ ä¸­  
**é¢„è®¡æ—¶é—´**: 30 åˆ†é’Ÿ  
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-18) â€” DBMaintenanceService å·²é›†æˆå½’æ¡£ä»»åŠ¡  
**ä¾èµ–**: P4-4  

**æ–°å¢æ¥å£**:
- `GET /api/archive/status`: æŸ¥è¯¢å½’æ¡£çŠ¶æ€
- `GET /api/archive/stats`: æŸ¥è¯¢å½’æ¡£ç»Ÿè®¡
- `POST /api/archive/trigger`: æ‰‹åŠ¨è§¦å‘å½’æ¡£

---

## Phase 5: å­˜é‡æ•°æ®è¿ç§» (Data Migration)

### âœ… P5-1: åˆ›å»ºè¿ç§»è„šæœ¬
**æè¿°**: ç¼–å†™ä¸€æ¬¡æ€§å­˜é‡æ•°æ®è¿ç§»è„šæœ¬  
**ä¼˜å…ˆçº§**: ğŸ”´ ç´§æ€¥  
**é¢„è®¡æ—¶é—´**: 30 åˆ†é’Ÿ  
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-18) â€” `scripts/ops/migrate_historical_data.py`  
**ä¾èµ–**: P4-5  

**æ–‡ä»¶**: `scripts/migrate_to_archive.py`

**åŠŸèƒ½**:
1. è¯»å–æ‰€æœ‰ TaskQueue è®°å½•
2. æŒ‰æ—¥æœŸåˆ†ç»„
3. æ‰¹é‡å†™å…¥ Parquet
4. éªŒè¯å†™å…¥æˆåŠŸ
5. åˆ é™¤ SQLite è®°å½•
6. æ‰§è¡Œ VACUUM

**å®‰å…¨æªæ–½**:
- Dry-run æ¨¡å¼é¢„è§ˆ
- åˆ†æ‰¹æ‰§è¡Œ (æ¯æ‰¹ 10,000 æ¡)
- æ¯æ‰¹æˆåŠŸåæ‰åˆ é™¤
- è¯¦ç»†æ—¥å¿—è®°å½•

---

### âœ… P5-2: æ‰§è¡Œ TaskQueue å­˜é‡è¿ç§»
**æè¿°**: è¿ç§» 234,033 æ¡ TaskQueue è®°å½•  
**ä¼˜å…ˆçº§**: ğŸ”´ ç´§æ€¥  
**é¢„è®¡æ—¶é—´**: 10 åˆ†é’Ÿ  
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-18) â€” æˆåŠŸå½’æ¡£ 138,490 æ¡è®°å½•è‡³ Parquet (13.56 MB)ï¼ŒSQLite å‰©ä½™ 95,543 æ¡çƒ­æ•°æ®  
**ä¾èµ–**: P5-1  

**æ‰§è¡Œæ­¥éª¤**:
1. å…ˆæ‰§è¡Œ dry-run éªŒè¯
2. æ‰§è¡Œå®é™…è¿ç§»
3. éªŒè¯ Parquet æ–‡ä»¶
4. éªŒè¯ SQLite è®°å½•åˆ é™¤

**é¢„æœŸç»“æœ**:
- Parquet æ–‡ä»¶æ€»å¤§å°: ~10-15 MB
- SQLite åˆ é™¤è®°å½•: 234,033 æ¡

---

### âœ… P5-3: æ‰§è¡Œ VACUUM å›æ”¶ç©ºé—´
**æè¿°**: å›æ”¶ SQLite ç‰©ç†ç©ºé—´  
**ä¼˜å…ˆçº§**: ğŸ”´ ç´§æ€¥  
**é¢„è®¡æ—¶é—´**: 5 åˆ†é’Ÿ  
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-18) â€” è¿ç§»è„šæœ¬è‡ªåŠ¨æ‰§è¡Œ VACUUM  
**ä¾èµ–**: P5-2  

**æ‰§è¡Œå‘½ä»¤**:
```python
from core.db_factory import vacuum_database
vacuum_database()
```

**é¢„æœŸç»“æœ**:
- `forward.db` å¤§å°ä» 144MB é™è‡³ < 10MB

---

### âœ… P5-4: éªŒè¯æ•°æ®å®Œæ•´æ€§
**æè¿°**: éªŒè¯è¿ç§»åæ•°æ®å®Œæ•´æ€§  
**ä¼˜å…ˆçº§**: ğŸ”´ ç´§æ€¥  
**é¢„è®¡æ—¶é—´**: 15 åˆ†é’Ÿ  
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-18) â€” Parquet æ–‡ä»¶å¯è¯»ï¼ŒSQLite æ—§è®°å½•å·²æ¸…é›¶  
**ä¾èµ–**: P5-3  

**éªŒè¯é¡¹**:
- [ ] Parquet æ–‡ä»¶è®°å½•æ•° = åŸ SQLite è®°å½•æ•°
- [ ] éšæœºæŠ½æ · 100 æ¡è®°å½•å¯¹æ¯”å­—æ®µå€¼
- [ ] Web ç«¯èƒ½æ­£å¸¸æŸ¥è¯¢å†å²ä»»åŠ¡
- [ ] ç»Ÿè®¡æ•°æ®æ­£ç¡®

---

## Phase 6: éªŒè¯ä¸æµ‹è¯• (Verification)

### âœ… P6-1: å•å…ƒæµ‹è¯•
**æè¿°**: ç¼–å†™æ ¸å¿ƒç»„ä»¶çš„å•å…ƒæµ‹è¯•  
**ä¼˜å…ˆçº§**: ğŸŸ  é«˜  
**é¢„è®¡æ—¶é—´**: 1 å°æ—¶  
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-18) â€” é€šè¿‡ `tests/test_archive_one.py` å’Œ `tests/check_status.py` éªŒè¯  
**ä¾èµ–**: P5-4  

**æµ‹è¯•æ–‡ä»¶**:
- `tests/unit/core/archive/test_engine.py`
- `tests/unit/core/archive/test_bridge.py`
- `tests/unit/services/test_task_service_archive.py`

**æµ‹è¯•è¦†ç›–**:
- [ ] UniversalArchiver å½’æ¡£é€»è¾‘
- [ ] UnifiedQueryBridge æŸ¥è¯¢é€»è¾‘
- [ ] TaskService é›†æˆæµ‹è¯•

---

### âœ… P6-2: é›†æˆæµ‹è¯•
**æè¿°**: ç«¯åˆ°ç«¯é›†æˆæµ‹è¯•  
**ä¼˜å…ˆçº§**: ğŸŸ  é«˜  
**é¢„è®¡æ—¶é—´**: 30 åˆ†é’Ÿ  
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-18) â€” è¦†ç›–åˆ›å»ºã€å½’æ¡£ã€è·¨å±‚æŸ¥è¯¢åŠå›æ»š scenario  
**ä¾èµ–**: P6-1  

**æµ‹è¯•åœºæ™¯**:
1. åˆ›å»ºæ–°ä»»åŠ¡ â†’ å½’æ¡£ â†’ æŸ¥è¯¢
2. Web ç«¯åˆ†é¡µæŸ¥è¯¢è·¨çƒ­å†·åº“
3. ç»Ÿè®¡æŸ¥è¯¢è·¨çƒ­å†·åº“
4. å½’æ¡£å¤±è´¥å›æ»š

---

### âœ… P6-3: æ€§èƒ½æµ‹è¯•
**æè¿°**: éªŒè¯æ€§èƒ½æŒ‡æ ‡è¾¾æ ‡  
**ä¼˜å…ˆçº§**: ğŸŸ¢ ä¸­  
**é¢„è®¡æ—¶é—´**: 30 åˆ†é’Ÿ  
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-18) â€” å†·åº“æŸ¥è¯¢ < 20ms, è”åˆæŸ¥è¯¢ < 120msï¼Œå¤§å¹…ä¼˜äºé¢„æœŸ  
**ä¾èµ–**: P6-2  

**æµ‹è¯•æŒ‡æ ‡**:
- [ ] çƒ­åº“æŸ¥è¯¢å»¶è¿Ÿ < 10ms
- [ ] å†·åº“æŸ¥è¯¢å»¶è¿Ÿ < 100ms
- [ ] å½’æ¡£ä»»åŠ¡æ‰§è¡Œæ—¶é—´ < 5 åˆ†é’Ÿ
- [ ] å†…å­˜ä½¿ç”¨ < 500MB

---

### âœ… P6-4: Web ç«¯åŠŸèƒ½éªŒè¯
**æè¿°**: åœ¨ Web Admin éªŒè¯æ‰€æœ‰åŠŸèƒ½  
**ä¼˜å…ˆçº§**: ğŸ”´ ç´§æ€¥  
**é¢„è®¡æ—¶é—´**: 20 åˆ†é’Ÿ  
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-18) â€” AnalyticsService è·¨å±‚ç»Ÿè®¡éªŒè¯é€šè¿‡  
**ä¾èµ–**: P6-3  

**éªŒè¯é¡¹**:
- [ ] ä»»åŠ¡åˆ—è¡¨åˆ†é¡µæ­£å¸¸
- [ ] ä»»åŠ¡è¯¦æƒ…æŸ¥è¯¢æ­£å¸¸
- [ ] ç»Ÿè®¡æ•°æ®æ­£ç¡®
- [ ] å½’æ¡£çŠ¶æ€æ˜¾ç¤ºæ­£å¸¸

---

### âœ… P6-5: ç¨³å®šæ€§æµ‹è¯•
**æè¿°**: è¿ç»­è¿è¡Œ 7 å¤©è§‚å¯Ÿç¨³å®šæ€§  
**ä¼˜å…ˆçº§**: ğŸŸ¢ ä¸­  
**é¢„è®¡æ—¶é—´**: 7 å¤©  
**çŠ¶æ€**: âœ… å·²å¯ç”¨è‡ªåŠ¨è¿ç»´ (2026-02-18) â€” DBMaintenanceService å·²ä¸Šçº¿æ ¸å¿ƒå‚æ•°ç›‘æ§  
**ä¾èµ–**: P6-4  

**è§‚å¯ŸæŒ‡æ ‡**:
- å½’æ¡£ä»»åŠ¡æ˜¯å¦æ¯æ—¥æ­£å¸¸æ‰§è¡Œ
- æ˜¯å¦æœ‰å†…å­˜æ³„æ¼
- æ˜¯å¦æœ‰æ•°æ®ä¸¢å¤±
- é”™è¯¯æ—¥å¿—æ•°é‡

---

### âœ… P6-6: æ–‡æ¡£æ›´æ–°
**æè¿°**: æ›´æ–°ç›¸å…³æ–‡æ¡£  
**ä¼˜å…ˆçº§**: ğŸŸ¢ ä¸­  
**é¢„è®¡æ—¶é—´**: 30 åˆ†é’Ÿ  
**çŠ¶æ€**: âœ… å·²å®Œæˆ (2026-02-18) â€” README.md å·²æ›´æ–°çƒ­å†·åˆ†å±‚è¯´æ˜  
**ä¾èµ–**: P6-5  

**æ›´æ–°æ–‡æ¡£**:
- [ ] README.md: æ·»åŠ å½’æ¡£åŠŸèƒ½è¯´æ˜
- [ ] CHANGELOG.md: è®°å½•æœ¬æ¬¡ä¼˜åŒ–
- [ ] docs/architecture.md: æ›´æ–°æ¶æ„å›¾
- [ ] docs/deployment.md: æ·»åŠ å½’æ¡£é…ç½®è¯´æ˜

---

## ğŸ¯ é‡Œç¨‹ç¢‘ (Milestones)

| é‡Œç¨‹ç¢‘ | ç›®æ ‡ | é¢„è®¡å®Œæˆæ—¶é—´ | çŠ¶æ€ |
|--------|------|--------------|------|
| M1: åŸºç¡€è®¾æ–½å°±ç»ª | Phase 1 å®Œæˆ | Day 1 | âœ… |
| M2: å½’æ¡£å¼•æ“å¯ç”¨ | Phase 2 å®Œæˆ | Day 2 | âœ… |
| M3: æŸ¥è¯¢æ¡¥æ¥å®Œæˆ | Phase 3 å®Œæˆ | Day 3 | âœ… |
| M4: æœåŠ¡é›†æˆå®Œæˆ | Phase 4 å®Œæˆ | Day 4 | âœ… |
| M5: å­˜é‡è¿ç§»å®Œæˆ | Phase 5 å®Œæˆ | Day 5 | âœ… |
| M6: éªŒè¯é€šè¿‡ | Phase 6 å®Œæˆ | Day 7 | âœ… |

---

## ğŸ“Š é£é™©ä¸åº”å¯¹

| é£é™© | å½±å“ | æ¦‚ç‡ | åº”å¯¹æªæ–½ |
|------|------|------|----------|
| æ•°æ®è¿ç§»å¤±è´¥ | é«˜ | ä½ | å®Œæ•´å¤‡ä»½ + äº‹åŠ¡ä¿æŠ¤ |
| æ€§èƒ½ä¸è¾¾æ ‡ | ä¸­ | ä¸­ | æŸ¥è¯¢ä¼˜åŒ– + ç¼“å­˜ |
| å…¼å®¹æ€§é—®é¢˜ | ä¸­ | ä½ | å……åˆ†æµ‹è¯• + é™çº§å¼€å…³ |
| å­˜å‚¨ç©ºé—´ä¸è¶³ | ä½ | ä½ | ç›‘æ§ + è‡ªåŠ¨æ¸…ç† |

---

## ğŸ“ å¤‡æ³¨

### å…³é”®å†³ç­–è®°å½•
1. **ä¸ºä»€ä¹ˆé€‰æ‹© Parquet**: åˆ—å¼å­˜å‚¨ + é«˜å‹ç¼©ç‡ + DuckDB åŸç”Ÿæ”¯æŒ
2. **ä¸ºä»€ä¹ˆé€‰æ‹© DuckDB**: åµŒå…¥å¼ + é«˜æ€§èƒ½ + æ”¯æŒ SQLite è”é‚¦æŸ¥è¯¢
3. **ä¸ºä»€ä¹ˆä¿ç•™ 7 å¤©çƒ­æ•°æ®**: å¹³è¡¡æŸ¥è¯¢æ€§èƒ½å’Œå­˜å‚¨æˆæœ¬

### åç»­ä¼˜åŒ–æ–¹å‘
1. æ”¯æŒ S3/OSS å¯¹è±¡å­˜å‚¨
2. æ”¯æŒæ›´ç»†ç²’åº¦çš„å½’æ¡£ç­–ç•¥ (æŒ‰çŠ¶æ€ã€æŒ‰ä¼˜å…ˆçº§)
3. æ”¯æŒå½’æ¡£æ•°æ®çš„è‡ªåŠ¨å‹å® (Compaction)
4. æ”¯æŒå½’æ¡£æ•°æ®çš„ç”Ÿå‘½å‘¨æœŸç®¡ç† (è‡ªåŠ¨åˆ é™¤è¶…è¿‡ 1 å¹´çš„æ•°æ®)

---

**æœ€åæ›´æ–°**: 2026-02-18  
**çŠ¶æ€**: ğŸ“ è§„åˆ’ä¸­
