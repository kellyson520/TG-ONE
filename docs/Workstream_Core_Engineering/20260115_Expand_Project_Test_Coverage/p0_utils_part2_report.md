# P0 Critical Utils æµ‹è¯•å®æ–½æŠ¥å‘Š (Part 2)

## ğŸ“… æ‰§è¡Œæ—¶é—´
2026-01-15 22:06 - 22:15

## ğŸ¯ ç›®æ ‡
å®Œæˆå‰©ä½™ P0 (Critical) ä¼˜å…ˆçº§çš„ Utils æ¨¡å—å•å…ƒæµ‹è¯•ï¼š
- common.py helpers
- realtime_stats.py
- bot_heartbeat.py

## âœ… å·²å®Œæˆæ¨¡å— (ä»£ç ç¼–å†™)

### 1. common.py helpers âœ…
**æµ‹è¯•æ–‡ä»¶**: `tests/unit/utils/test_common.py`
**è¦†ç›–åŠŸèƒ½**:
- `check_keywords`: è¦†ç›–é»‘/ç™½åå•ã€åè½¬é»‘/ç™½åå•å››ç§æ¨¡å¼ç»„åˆã€‚
- `check_keywords_fast`: æ­£åˆ™åŒ¹é…å’Œæ™®é€šåŒ¹é…ã€‚
- `is_admin`: ç¯å¢ƒå˜é‡å’Œæ•°æ®åº“åŒé‡æ£€æŸ¥é€»è¾‘ã€‚
- `get_user_id` / `get_admin_list`: ç¯å¢ƒå˜é‡å›é€€é€»è¾‘ã€‚
**æµ‹è¯•ç­–ç•¥**:
- Mock `ACManager` é¿å…å¤æ‚çš„è‡ªåŠ¨æœºåˆå§‹åŒ–ã€‚
- Mock æ•°æ®åº“ Session é¿å…è¿æ¥çœŸå®æ•°æ®åº“ã€‚

### 2. realtime_stats.py âœ…
**æµ‹è¯•æ–‡ä»¶**: `tests/unit/utils/test_realtime_stats.py`
**è¦†ç›–åŠŸèƒ½**:
- ç¼“å­˜å‘½ä¸­ä¸ TTL éªŒè¯ã€‚
- `force_refresh` é€»è¾‘ï¼šå¼ºåˆ¶ä» Service è·å–å¹¶æ›´æ–°ç¼“å­˜ã€‚
- `get_main_menu_stats`: èšåˆæ¥å£åŠå¼‚å¸¸å¤„ç†ã€‚
- å›è°ƒé€šçŸ¥æœºåˆ¶ã€‚
**Mock ç­–ç•¥**: 
- Mock `forward_service`ã€`dedup_service`ã€`analytics_service` å’Œ `persistent_cache`ã€‚

### 3. bot_heartbeat.py âœ…
**æµ‹è¯•æ–‡ä»¶**: `tests/unit/utils/test_bot_heartbeat.py`
**è¦†ç›–åŠŸèƒ½**:
- å¿ƒè·³æ•°æ®è¯»å–ä¸ JSON è§£æã€‚
- `start_heartbeat`: å¾ªç¯ä»»åŠ¡é€»è¾‘ã€æ–­çº¿é‡è¿çŠ¶æ€æ›´æ–°ã€‚
**Mock ç­–ç•¥**:
- æ¨¡æ‹Ÿ `asyncio.sleep` æŠ›å‡º `CancelledError` ä»¥æµ‹è¯•æ— é™å¾ªç¯åç¨‹çš„é€€å‡ºæœºåˆ¶ã€‚

## âš ï¸ ç¯å¢ƒé—®é¢˜ä¸éªŒè¯å—é˜»

**ç°è±¡**:
- åœ¨è¿è¡Œ `test_db_operations.py`, `test_unified_sender.py`, `test_id_utils.py` æ—¶ä¸€åˆ‡æ­£å¸¸ã€‚
- åœ¨åç»­è¿è¡Œæ–°ç¼–å†™çš„æµ‹è¯•ï¼ˆç”šè‡³æœ€ç®€å•çš„ç¯å¢ƒæ£€æµ‹è„šæœ¬ï¼‰æ—¶ï¼Œ`pytest` è¿›ç¨‹å¯åŠ¨åæ— ä»»ä½•è¾“å‡ºå¹¶æŒ‚èµ·ï¼ˆHangï¼‰ã€‚
- `taskkill` å‘½ä»¤æ— æ³•æœ‰æ•ˆç»ˆæ­¢åƒµå°¸è¿›ç¨‹ã€‚

**è¯Šæ–­**:
- å¯èƒ½æ˜¯ä¹‹å‰çš„æµ‹è¯•ç•™ä¸‹äº†æœªé‡Šæ”¾çš„èµ„æºï¼ˆå¦‚ event loop æœªå…³é—­ã€æ–‡ä»¶é”ã€æˆ– log handler é˜»å¡ï¼‰ã€‚
- å½“å‰ç»ˆç«¯ä¼šè¯çš„ Python ç¯å¢ƒå¯èƒ½å·²æŸåã€‚

**å»ºè®®è¡ŒåŠ¨**:
1. **é‡å¯å¼€å‘ç¯å¢ƒ/ç»ˆç«¯**: å…³é—­æ‰€æœ‰ Python è¿›ç¨‹å’Œç»ˆç«¯çª—å£ï¼Œé‡æ–°å¯åŠ¨ã€‚
2. **å•ç‹¬è¿è¡ŒéªŒè¯**: é‡å¯åï¼Œåˆ†åˆ«å•ç‹¬è¿è¡Œæ–°åˆ›å»ºçš„æµ‹è¯•æ–‡ä»¶ï¼š
   ```bash
   pytest tests/unit/utils/test_common.py -v
   pytest tests/unit/utils/test_realtime_stats.py -v
   pytest tests/unit/utils/test_bot_heartbeat.py -v
   ```
3. **æ£€æŸ¥èµ„æºæ³„æ¼**: ä»£ç å®¡æŸ¥æ˜¾ç¤ºå·²å°½å¯èƒ½ Mock äº†å¤–éƒ¨èµ„æºï¼Œä½†éœ€æ³¨æ„ `ACManager` ç­‰å•ä¾‹æ¨¡å¼å¯èƒ½å¸¦æ¥çš„å‰¯ä½œç”¨ã€‚

## ğŸ“Š æ•´ä½“è¿›åº¦ (P0 Critical Utils)

| æ¨¡å— | çŠ¶æ€ | å¤‡æ³¨ |
| :--- | :--- | :--- |
| db_operations.py | âœ… å®Œæˆ | å·²éªŒè¯é€šè¿‡ |
| forward_recorder.py | âœ… å®Œæˆ | å·²éªŒè¯é€šè¿‡ |
| unified_sender.py | âœ… å®Œæˆ | å·²éªŒè¯é€šè¿‡ |
| id_utils.py | âœ… å®Œæˆ | å·²éªŒè¯é€šè¿‡ |
| common.py | âš ï¸ ä»£ç å®Œæˆ | ç¯å¢ƒé˜»å¡ï¼Œå¾…éªŒè¯ |
| realtime_stats.py | âš ï¸ ä»£ç å®Œæˆ | ç¯å¢ƒé˜»å¡ï¼Œå¾…éªŒè¯ |
| bot_heartbeat.py | âš ï¸ ä»£ç å®Œæˆ | ç¯å¢ƒé˜»å¡ï¼Œå¾…éªŒè¯ |

## ğŸš€ ä¸‹ä¸€æ­¥è®¡åˆ’ (P1)

1. **ç¯å¢ƒæ¢å¤**: ç¡®ä¿æµ‹è¯•ç¯å¢ƒæ¢å¤æ­£å¸¸ã€‚
2. **Processing Utils**: å®ç° `smart_dedup.py` ç­‰å¤„ç†å·¥å…·çš„æµ‹è¯•ã€‚
3. **Routers Phase 2**: å¼€å§‹ Stats å’Œ Settings è·¯ç”±çš„æµ‹è¯•ã€‚

---
**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2026-01-15 22:15
**æ‰§è¡Œäºº**: Antigravity AI Agent
