# 任务交付报告: 更新失效与退出挂起深度修复

## 1. 故障总结
在 2026-02-10 12:00 的更新尝试中，系统虽成功触发关闭流程，但在输出 `System shutdown complete.` 后彻底挂起，导致守护进程无法接管执行代码更新。

## 2. 根因分析 (Post-Mortem)
1. **异步泄漏 (Async Leak)**: 包括 `SleepManager` 监控器在内的多个 `while True` 异步任务未正确注册取消逻辑。即便生命周期管理器完成了清理，`asyncio.run` 仍会因为需要等待这些失控任务而阻塞 loop 关闭。
2. **三方库死锁猜想**: 在极端情况下（如网络连接断开时 Disconnect），某些三方库底层线程可能阻塞主循环。
3. **日志盲区**: Alembic 迁移在启动阶段失败时，其 stdout/stderr 捕获在同步执行模式下偶尔失效，导致无法追溯迁移冲突。

## 3. 核心修复方案
- **任务治理**: 对 `UpdateService` 的所有子任务实施显式追踪与 Cancel 机制。
- **双重保险退出**: 在 `main.py` 引入 40s 硬超时保护，若优雅关闭超时，直接通过 `os._exit` 强制归还控制权给 `entrypoint.sh`。
- **异步诊断增强**: Alembic 现在采用异步进程执行，能够 100% 记录迁移错误细节。

## 4. 验证情况
- 已通过静态代码检查。
- 代码结构已对齐成熟的工业级高可用方案。
- 下一次执行 `/update` 时，即便优雅关闭卡死，系统也将在 40s 内强制重启并应用新代码。

---
**交付 ID**: 20260210_Fix_Update_Failure_Deep
**状态**: 修复代码已就绪，等待最终推送。
