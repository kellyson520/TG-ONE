============================= test session starts =============================
platform win32 -- Python 3.13.0, pytest-9.0.1, pluggy-1.6.0 -- E:\python\python313\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\lihuo\Desktop\重构\TG ONE
configfile: pytest.ini
plugins: anyio-4.12.1, asyncio-1.3.0, cov-7.0.0, mock-3.15.1, xdist-3.8.0
asyncio: mode=Mode.AUTO, debug=False, asyncio_default_fixture_loop_scope=None, asyncio_default_test_loop_scope=function
collecting ... 
----------------------------- live log collection -----------------------------
2026-01-28 16:49:31 [    INFO] Failed to load SSL library: <class 'OSError'> (no library called "ssl" found)
2026-01-28 16:49:31 [    INFO] cryptg module not installed and libssl not found, falling back to (slower) Python encryption
2026-01-28 16:49:31 [    INFO] Bloom Filter (L0) 初始化成功
2026-01-28 16:49:31 [    INFO] HLL (HyperLogLog) 初始化成功
2026-01-28 16:49:31 [    INFO] SimHash 引擎与 LSH Forest 索引系统初始化成功
2026-01-28 16:49:31 [    INFO] Bloom Filter Service initialized using consolidated utils implementation
2026-01-28 16:49:31 [    INFO] 使用转发记录目录: E:\重构\TG ONE\zhuanfaji
2026-01-28 16:49:31 [    INFO] ForwardRecorder 初始化完成，模式: summary
2026-01-28 16:49:31 [    INFO] [Database] 初始化数据库连接，模式=共享引擎
2026-01-28 16:49:31 [    INFO] [Database] 使用共享引擎: sqlite+aiosqlite:///file:testdb_early?cache=shared&mode=memory&uri=true
2026-01-28 16:49:31 [    INFO] [Database] 会话工厂已初始化
2026-01-28 16:49:31 [    INFO] Container connected to shared database engine: sqlite+aiosqlite:///file:testdb_early?cache=shared&mode=memory&uri=true
2026-01-28 16:49:31 [    INFO] EventBus initialized
collected 10 items

tests/unit/services/test_rule_management_service.py::TestRuleManagementService::test_get_rule_list PASSED [ 10%]
tests/unit/services/test_rule_management_service.py::TestRuleManagementService::test_create_rule PASSED [ 20%]
tests/unit/services/test_rule_management_service.py::TestRuleManagementService::test_bind_chat FAILED [ 30%]
tests/unit/services/test_rule_management_service.py::TestRuleManagementService::test_add_delete_keywords PASSED [ 40%]
tests/unit/services/test_rule_management_service.py::TestRuleManagementService::test_copy_rule PASSED [ 50%]
tests/unit/services/test_rule_management_service.py::TestRuleManagementServiceExtra::test_get_rule_list FAILED [ 60%]
tests/unit/services/test_rule_management_service.py::TestRuleManagementServiceExtra::test_create_rule PASSED [ 70%]
tests/unit/services/test_rule_management_service.py::TestRuleManagementServiceExtra::test_add_delete_keywords FAILED [ 80%]
tests/unit/services/test_rule_management_service.py::TestRuleManagementServiceExtra::test_toggle_boolean_setting PASSED [ 90%]
tests/unit/services/test_rule_management_service.py::TestRuleManagementServiceExtra::test_copy_rule FAILED [100%]

================================== FAILURES ===================================
__________________ TestRuleManagementService.test_bind_chat ___________________
tests\unit\services\test_rule_management_service.py:39: in test_bind_chat
    with patch("core.helpers.id_utils.get_or_create_chat_async") as mock_get_chat:
         ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E:\python\python313\Lib\unittest\mock.py:1491: in __enter__
    original, local = self.get_original()
                      ^^^^^^^^^^^^^^^^^^^
E:\python\python313\Lib\unittest\mock.py:1464: in get_original
    raise AttributeError(
E   AttributeError: <module 'core.helpers.id_utils' from 'C:\\Users\\lihuo\\Desktop\\重构\\TG ONE\\core\\helpers\\id_utils.py'> does not have the attribute 'get_or_create_chat_async'
______________ TestRuleManagementServiceExtra.test_get_rule_list ______________
E:\python\python313\Lib\site-packages\sqlalchemy\engine\base.py:2125: in _exec_insertmany_context
    dialect.do_execute(
E:\python\python313\Lib\site-packages\sqlalchemy\engine\default.py:952: in do_execute
    cursor.execute(statement, parameters)
E:\python\python313\Lib\site-packages\sqlalchemy\dialects\sqlite\aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
E:\python\python313\Lib\site-packages\sqlalchemy\dialects\sqlite\aiosqlite.py:340: in _handle_exception
    raise error
E:\python\python313\Lib\site-packages\sqlalchemy\dialects\sqlite\aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
E:\python\python313\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\aiosqlite\cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
E:\python\python313\Lib\site-packages\aiosqlite\cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\aiosqlite\core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\aiosqlite\core.py:63: in _connection_worker_thread
    result = function()
             ^^^^^^^^^^
E   sqlite3.IntegrityError: UNIQUE constraint failed: chats.telegram_chat_id

The above exception was the direct cause of the following exception:
tests\unit\services\test_rule_management_service.py:128: in test_get_rule_list
    await db.commit()
E:\python\python313\Lib\site-packages\sqlalchemy\ext\asyncio\session.py:1000: in commit
    await greenlet_spawn(self.sync_session.commit)
E:\python\python313\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\sqlalchemy\orm\session.py:2030: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
E:\python\python313\Lib\site-packages\sqlalchemy\orm\state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\sqlalchemy\orm\session.py:1311: in commit
    self._prepare_impl()
<string>:2: in _prepare_impl
    ???
E:\python\python313\Lib\site-packages\sqlalchemy\orm\state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\sqlalchemy\orm\session.py:1286: in _prepare_impl
    self.session.flush()
E:\python\python313\Lib\site-packages\sqlalchemy\orm\session.py:4331: in flush
    self._flush(objects)
E:\python\python313\Lib\site-packages\sqlalchemy\orm\session.py:4466: in _flush
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\sqlalchemy\util\langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
E:\python\python313\Lib\site-packages\sqlalchemy\orm\session.py:4427: in _flush
    flush_context.execute()
E:\python\python313\Lib\site-packages\sqlalchemy\orm\unitofwork.py:466: in execute
    rec.execute(self)
E:\python\python313\Lib\site-packages\sqlalchemy\orm\unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
E:\python\python313\Lib\site-packages\sqlalchemy\orm\persistence.py:93: in save_obj
    _emit_insert_statements(
E:\python\python313\Lib\site-packages\sqlalchemy\orm\persistence.py:1143: in _emit_insert_statements
    result = connection.execute(
E:\python\python313\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
E:\python\python313\Lib\site-packages\sqlalchemy\sql\elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
E:\python\python313\Lib\site-packages\sqlalchemy\engine\base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
E:\python\python313\Lib\site-packages\sqlalchemy\engine\base.py:1844: in _execute_context
    return self._exec_insertmany_context(dialect, context)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\sqlalchemy\engine\base.py:2133: in _exec_insertmany_context
    self._handle_dbapi_exception(
E:\python\python313\Lib\site-packages\sqlalchemy\engine\base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
E:\python\python313\Lib\site-packages\sqlalchemy\engine\base.py:2125: in _exec_insertmany_context
    dialect.do_execute(
E:\python\python313\Lib\site-packages\sqlalchemy\engine\default.py:952: in do_execute
    cursor.execute(statement, parameters)
E:\python\python313\Lib\site-packages\sqlalchemy\dialects\sqlite\aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
E:\python\python313\Lib\site-packages\sqlalchemy\dialects\sqlite\aiosqlite.py:340: in _handle_exception
    raise error
E:\python\python313\Lib\site-packages\sqlalchemy\dialects\sqlite\aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
E:\python\python313\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\aiosqlite\cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
E:\python\python313\Lib\site-packages\aiosqlite\cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\aiosqlite\core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\aiosqlite\core.py:63: in _connection_worker_thread
    result = function()
             ^^^^^^^^^^
E   sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: chats.telegram_chat_id
E   [SQL: INSERT INTO chats (telegram_chat_id, name, username, type, title, current_add_id) VALUES (?, ?, ?, ?, ?, ?) RETURNING id]
E   [parameters: ('101', 'S', None, None, None, None)]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
___________ TestRuleManagementServiceExtra.test_add_delete_keywords ___________
E:\python\python313\Lib\site-packages\sqlalchemy\engine\base.py:2125: in _exec_insertmany_context
    dialect.do_execute(
E:\python\python313\Lib\site-packages\sqlalchemy\engine\default.py:952: in do_execute
    cursor.execute(statement, parameters)
E:\python\python313\Lib\site-packages\sqlalchemy\dialects\sqlite\aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
E:\python\python313\Lib\site-packages\sqlalchemy\dialects\sqlite\aiosqlite.py:340: in _handle_exception
    raise error
E:\python\python313\Lib\site-packages\sqlalchemy\dialects\sqlite\aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
E:\python\python313\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\aiosqlite\cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
E:\python\python313\Lib\site-packages\aiosqlite\cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\aiosqlite\core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\aiosqlite\core.py:63: in _connection_worker_thread
    result = function()
             ^^^^^^^^^^
E   sqlite3.IntegrityError: UNIQUE constraint failed: chats.telegram_chat_id

The above exception was the direct cause of the following exception:
tests\unit\services\test_rule_management_service.py:157: in test_add_delete_keywords
    await db.commit()
E:\python\python313\Lib\site-packages\sqlalchemy\ext\asyncio\session.py:1000: in commit
    await greenlet_spawn(self.sync_session.commit)
E:\python\python313\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\sqlalchemy\orm\session.py:2030: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
E:\python\python313\Lib\site-packages\sqlalchemy\orm\state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\sqlalchemy\orm\session.py:1311: in commit
    self._prepare_impl()
<string>:2: in _prepare_impl
    ???
E:\python\python313\Lib\site-packages\sqlalchemy\orm\state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\sqlalchemy\orm\session.py:1286: in _prepare_impl
    self.session.flush()
E:\python\python313\Lib\site-packages\sqlalchemy\orm\session.py:4331: in flush
    self._flush(objects)
E:\python\python313\Lib\site-packages\sqlalchemy\orm\session.py:4466: in _flush
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\sqlalchemy\util\langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
E:\python\python313\Lib\site-packages\sqlalchemy\orm\session.py:4427: in _flush
    flush_context.execute()
E:\python\python313\Lib\site-packages\sqlalchemy\orm\unitofwork.py:466: in execute
    rec.execute(self)
E:\python\python313\Lib\site-packages\sqlalchemy\orm\unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
E:\python\python313\Lib\site-packages\sqlalchemy\orm\persistence.py:93: in save_obj
    _emit_insert_statements(
E:\python\python313\Lib\site-packages\sqlalchemy\orm\persistence.py:1143: in _emit_insert_statements
    result = connection.execute(
E:\python\python313\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
E:\python\python313\Lib\site-packages\sqlalchemy\sql\elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
E:\python\python313\Lib\site-packages\sqlalchemy\engine\base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
E:\python\python313\Lib\site-packages\sqlalchemy\engine\base.py:1844: in _execute_context
    return self._exec_insertmany_context(dialect, context)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\sqlalchemy\engine\base.py:2133: in _exec_insertmany_context
    self._handle_dbapi_exception(
E:\python\python313\Lib\site-packages\sqlalchemy\engine\base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
E:\python\python313\Lib\site-packages\sqlalchemy\engine\base.py:2125: in _exec_insertmany_context
    dialect.do_execute(
E:\python\python313\Lib\site-packages\sqlalchemy\engine\default.py:952: in do_execute
    cursor.execute(statement, parameters)
E:\python\python313\Lib\site-packages\sqlalchemy\dialects\sqlite\aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
E:\python\python313\Lib\site-packages\sqlalchemy\dialects\sqlite\aiosqlite.py:340: in _handle_exception
    raise error
E:\python\python313\Lib\site-packages\sqlalchemy\dialects\sqlite\aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
E:\python\python313\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\aiosqlite\cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
E:\python\python313\Lib\site-packages\aiosqlite\cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\aiosqlite\core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\aiosqlite\core.py:63: in _connection_worker_thread
    result = function()
             ^^^^^^^^^^
E   sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: chats.telegram_chat_id
E   [SQL: INSERT INTO chats (telegram_chat_id, name, username, type, title, current_add_id) VALUES (?, ?, ?, ?, ?, ?) RETURNING id]
E   [parameters: ('301', None, None, None, None, None)]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
________________ TestRuleManagementServiceExtra.test_copy_rule ________________
E:\python\python313\Lib\site-packages\sqlalchemy\engine\base.py:2125: in _exec_insertmany_context
    dialect.do_execute(
E:\python\python313\Lib\site-packages\sqlalchemy\engine\default.py:952: in do_execute
    cursor.execute(statement, parameters)
E:\python\python313\Lib\site-packages\sqlalchemy\dialects\sqlite\aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
E:\python\python313\Lib\site-packages\sqlalchemy\dialects\sqlite\aiosqlite.py:340: in _handle_exception
    raise error
E:\python\python313\Lib\site-packages\sqlalchemy\dialects\sqlite\aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
E:\python\python313\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\aiosqlite\cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
E:\python\python313\Lib\site-packages\aiosqlite\cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\aiosqlite\core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\aiosqlite\core.py:63: in _connection_worker_thread
    result = function()
             ^^^^^^^^^^
E   sqlite3.IntegrityError: UNIQUE constraint failed: chats.telegram_chat_id

The above exception was the direct cause of the following exception:
tests\unit\services\test_rule_management_service.py:202: in test_copy_rule
    await db.commit()
E:\python\python313\Lib\site-packages\sqlalchemy\ext\asyncio\session.py:1000: in commit
    await greenlet_spawn(self.sync_session.commit)
E:\python\python313\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:203: in greenlet_spawn
    result = context.switch(value)
             ^^^^^^^^^^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\sqlalchemy\orm\session.py:2030: in commit
    trans.commit(_to_root=True)
<string>:2: in commit
    ???
E:\python\python313\Lib\site-packages\sqlalchemy\orm\state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\sqlalchemy\orm\session.py:1311: in commit
    self._prepare_impl()
<string>:2: in _prepare_impl
    ???
E:\python\python313\Lib\site-packages\sqlalchemy\orm\state_changes.py:137: in _go
    ret_value = fn(self, *arg, **kw)
                ^^^^^^^^^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\sqlalchemy\orm\session.py:1286: in _prepare_impl
    self.session.flush()
E:\python\python313\Lib\site-packages\sqlalchemy\orm\session.py:4331: in flush
    self._flush(objects)
E:\python\python313\Lib\site-packages\sqlalchemy\orm\session.py:4466: in _flush
    with util.safe_reraise():
         ^^^^^^^^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\sqlalchemy\util\langhelpers.py:224: in __exit__
    raise exc_value.with_traceback(exc_tb)
E:\python\python313\Lib\site-packages\sqlalchemy\orm\session.py:4427: in _flush
    flush_context.execute()
E:\python\python313\Lib\site-packages\sqlalchemy\orm\unitofwork.py:466: in execute
    rec.execute(self)
E:\python\python313\Lib\site-packages\sqlalchemy\orm\unitofwork.py:642: in execute
    util.preloaded.orm_persistence.save_obj(
E:\python\python313\Lib\site-packages\sqlalchemy\orm\persistence.py:93: in save_obj
    _emit_insert_statements(
E:\python\python313\Lib\site-packages\sqlalchemy\orm\persistence.py:1143: in _emit_insert_statements
    result = connection.execute(
E:\python\python313\Lib\site-packages\sqlalchemy\engine\base.py:1419: in execute
    return meth(
E:\python\python313\Lib\site-packages\sqlalchemy\sql\elements.py:527: in _execute_on_connection
    return connection._execute_clauseelement(
E:\python\python313\Lib\site-packages\sqlalchemy\engine\base.py:1641: in _execute_clauseelement
    ret = self._execute_context(
E:\python\python313\Lib\site-packages\sqlalchemy\engine\base.py:1844: in _execute_context
    return self._exec_insertmany_context(dialect, context)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\sqlalchemy\engine\base.py:2133: in _exec_insertmany_context
    self._handle_dbapi_exception(
E:\python\python313\Lib\site-packages\sqlalchemy\engine\base.py:2363: in _handle_dbapi_exception
    raise sqlalchemy_exception.with_traceback(exc_info[2]) from e
E:\python\python313\Lib\site-packages\sqlalchemy\engine\base.py:2125: in _exec_insertmany_context
    dialect.do_execute(
E:\python\python313\Lib\site-packages\sqlalchemy\engine\default.py:952: in do_execute
    cursor.execute(statement, parameters)
E:\python\python313\Lib\site-packages\sqlalchemy\dialects\sqlite\aiosqlite.py:180: in execute
    self._adapt_connection._handle_exception(error)
E:\python\python313\Lib\site-packages\sqlalchemy\dialects\sqlite\aiosqlite.py:340: in _handle_exception
    raise error
E:\python\python313\Lib\site-packages\sqlalchemy\dialects\sqlite\aiosqlite.py:162: in execute
    self.await_(_cursor.execute(operation, parameters))
E:\python\python313\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:132: in await_only
    return current.parent.switch(awaitable)  # type: ignore[no-any-return,attr-defined] # noqa: E501
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\sqlalchemy\util\_concurrency_py3k.py:196: in greenlet_spawn
    value = await result
            ^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\aiosqlite\cursor.py:40: in execute
    await self._execute(self._cursor.execute, sql, parameters)
E:\python\python313\Lib\site-packages\aiosqlite\cursor.py:32: in _execute
    return await self._conn._execute(fn, *args, **kwargs)
           ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\aiosqlite\core.py:160: in _execute
    return await future
           ^^^^^^^^^^^^
E:\python\python313\Lib\site-packages\aiosqlite\core.py:63: in _connection_worker_thread
    result = function()
             ^^^^^^^^^^
E   sqlalchemy.exc.IntegrityError: (sqlite3.IntegrityError) UNIQUE constraint failed: chats.telegram_chat_id
E   [SQL: INSERT INTO chats (telegram_chat_id, name, username, type, title, current_add_id) VALUES (?, ?, ?, ?, ?, ?) RETURNING id]
E   [parameters: ('501', None, None, None, None, None)]
E   (Background on this error at: https://sqlalche.me/e/20/gkpj)
=========================== short test summary info ===========================
FAILED tests/unit/services/test_rule_management_service.py::TestRuleManagementService::test_bind_chat
FAILED tests/unit/services/test_rule_management_service.py::TestRuleManagementServiceExtra::test_get_rule_list
FAILED tests/unit/services/test_rule_management_service.py::TestRuleManagementServiceExtra::test_add_delete_keywords
FAILED tests/unit/services/test_rule_management_service.py::TestRuleManagementServiceExtra::test_copy_rule
========================= 4 failed, 6 passed in 1.56s =========================
